---
title: "Input data preparation"
format: html
editor: visual
---

```{r setup, message = TRUE, warning = TRUE}
# analysis packages
library(stars) # spatio-temporal raster processing
library(sf)
library(tidyverse)
library(terra)
# library(geodata) # geographic data
library(here) # cross-platform directory structures
library(readxl) # read excel spreadsheets
# library(dismo) # generating background points for niche model, not loaded but should be installed

# parallel processing
available_cores <- parallel::detectCores(logical = TRUE)

# visualization packages
library(rnaturalearth) # country boundaries

sf_use_s2(TRUE)

# define the study area
asia_bbox <- st_bbox(c(xmin = 60, xmax = 150, ymin = -20, ymax = 50), crs = 4326)
world_bbox <- st_bbox(c(xmin = -130, xmax = 155, ymin = -55, ymax = 60), crs = 4326)

bbox <- terra::ext(60, 150, -20, 50)
#bbox <- raster::extent(-130, 155, -55, 60)  # global

# get country boundaries shapefile for plotting
countries <- ne_countries(returnclass = "sf", scale = 'large') %>%
  st_crop(asia_bbox)
coasts <- ne_coastline(returnclass = 'sf') %>%
  st_crop(asia_bbox)

chelsa_mask <- terra::rast('../../CHELSA_V2_bio_clim/CHELSA_pet_penman_mean_1981-2010_V.2.1.tif') %>%
      terra::crop(bbox)

theme_set(theme_bw())
```

## Rice occurrence data

### Contemporary occurrence of rice and its wild progenitor

We used geolocated occurrence records for rice's wild progenitor (Oryza rufipogon G.) from GBIF/CHV via [here](https://www.sciencedirect.com/science/article/pii/S1574954122002631) . Also load occurrence records of domestic rice from the same source.

presence threshold for satellite imagery of 0.5

```{r warning = FALSE}
occ <- here('data/data-raw/Datasets of occurrence records of rice and its wild progenitor.xlsx')
rufipogon <- read_excel(occ, skip = 6715) %>%
  select(-x, -`the wild progenitor`) %>%
  st_as_sf(coords = 2:1, crs = 4326) %>%
  st_crop(asia_bbox) %>%
  mutate(rice = 'present')

sativa <- read_excel(occ, n_max = 6714) %>%
  remove_missing() %>%
  select(-x, -Rice) %>%
  st_as_sf(coords = 2:1, crs = 4326) %>%
   st_crop(asia_bbox) %>%
  mutate(rice = 'present')

ggplot() +
  geom_sf(data = countries, color = 'white') +
  geom_sf(data = sativa, size = 0.1, color = 'black') +
  geom_sf(data = rufipogon, color = 'green', size = 0.1) +
  labs(title = "Rice occurence data", subtitle = "O. sativa (modern, black), O. rufipogon (modern, green), O. sativa japonica (archaeological, red)", caption = 'source: GBIF, CHV, Rice Archaeological Database') +
  #geom_sf(data = arch, color = 'red', size = 0.11) +
  theme_minimal()
```

### Satellite-derived rice data

Lots of potential sources. SPAM is combination data, satellite, and model. [ChinaCropPhen1km](https://figshare.com/articles/dataset/ChinaCropPhen1km_A_high-resolution_crop_phenological_dataset_for_three_staple_crops_in_China_during_2000-2015_based_on_LAI_products/8313530/5) has rice from 2000-2015 daily at 1km. RiceAtlas is a census from 2010ish that's vectorized https://www.nature.com/articles/sdata201774 . Monfreda dissaggregates harvest area and yield census data proportionate to geospatial cropland mpas.[Source](https://iopscience.iop.org/article/10.1088/1748-9326/ac20f4)

Monfreda and Ramankutty -- I think this is just paddy as well. thisis 2008, but there is an update 2012 version by ray, updated again more cently. -- but this is harvested area, which is problematic because you can have multipel harvest a year

MODIS-RICE, good but not avavilable -- different versions from different times

SPAM data high quality but uses preexisting crop suitability maps in their downscaling so its not independent. It also uses satllite maps of just cropland extent, not necessarily of rice.

> We estimate the crop suitable area (SuitArea) from GAEZv3.0 to consider the spatially varied potential suitability for different crops in terms of different thermal, moisture, and soil requirements as an allocating parameter. https://essd.copernicus.org/articles/12/3545/2020/

```{r}
# this is just "paddy rice" according to documentation
monfreda_area <- geodata::crop_monfreda('rice', 
                                        var = 'area_ha', 
                                        here('data/data-raw')) %>%
  st_as_stars() %>%
  st_crop(asia_bbox) %>%
  setNames('area_ha')

monfreda_fraction <- geodata::crop_monfreda('rice', var = 'area_f', here('data/data-raw')) %>%
  st_as_stars() %>%
  st_crop(asia_bbox) %>%
  setNames('area_f')


monfreda_quality <- geodata::crop_monfreda('rice', var = 'area_q', here('data/data-raw')) %>%
  st_as_stars() %>%
  st_crop(asia_bbox) %>%
  setNames('area_q')

ray <- read_stars('data/data-raw/HarvAreaYield_4Crops_95-00-05_Geotiff/Rice/Rice_2000_Area.tif') %>%
  st_crop(asia_bbox)

ggplot() +
  geom_stars(data = monfreda_fraction ) +
  scale_fill_viridis_c() +
  geom_sf(data = coasts, color = 'white') +
  geom_sf(data = sativa, size = 0.5)

ggplot() +
  geom_stars(data = monfreda_fraction > 0.1 ) +
  scale_fill_viridis_d() +
  geom_sf(data = coasts, color = 'white') +
  geom_sf(data = sativa, size = 0.5)

ggplot() +
  geom_stars(data = ray > 0.1) +
  scale_fill_viridis_d() +
  geom_sf(data = coasts, color = 'white')  +
  geom_sf(data = sativa, size = 0.5, color = 'white')


ggplot() +
  geom_stars(data = monfreda_area) +
  scale_fill_viridis_c() +
  geom_sf(data = coasts, color = 'white') +
  geom_sf(data = sativa, size = 0.5, color = 'white')


ggplot() +
  geom_stars(data = monfreda_quality) +
  scale_fill_viridis_c() +
  geom_sf(data = coasts, color = 'white')


## not clear what this function is downlaoding exactly, this gives 6 layers with unclear names . . .
spam_area <- geodata::crop_spam('rice', 'phys_area', path = here('data/data-raw')) %>%
  st_as_stars() %>%
  st_crop(asia_bbox)

ggplot() +
  geom_stars(data = (spam_area)
) +
  scale_fill_viridis_c() +
  geom_sf(data = coasts, color = 'white') +
  geom_sf(data = sativa, size = 0.5, color = 'white', alpha = 0.1)
```

```{r}
rice_atlas_cal <- read_sf('data/data-raw/dataverse_files/RiceCalendar_v1/RiceCalendar_v1.shp') %>%
  st_crop(asia_bbox)

ggplot() +
  geom_sf(data = rice_atlas_cal, aes(fill = NUM_CROP)) +
  scale_fill_distiller(palette = 'Spectral')

rice_atlas_prod <- read_sf('data/data-raw/dataverse_files/RiceProduction_v1/RiceProduction_v1.shp') %>%
    st_crop(asia_bbox)
  
ggplot() +
  geom_sf(data = rice_atlas_prod, aes(fill = METHOD)) +
  scale_fill_brewer(palette = 'Spectral')
```

```{r}
read_sf('data/data-raw/13468929/RICA_geometry/geom_rica.shp') %>%
  st_crop(asia_bbox) %>%
  plot
```

Nelson and gumma, just lowland rice for asia... Andrew Nelson, Murali Krishna Gumma. A map of lowland rice extent in the major rice growing countries of Asia. 2015, 37p. IRRI, Los Banos, Philippines.

hard to verigy in china, maybe overpredictsw in norhteast china where there's wheat. also wetlands in indonesia

```{r}
irri <- rast('data/data-raw/IRRI Asia Rice Extent Map/asia-rice-extent.tif') %>%
  aggregate(fact = 20) %>%
  mask(., resample(chelsa_mask, .))

ggplot() +
  geom_stars(data = st_as_stars(irri)) +
  scale_fill_viridis_c() +
  geom_sf(data = coasts, color = 'white')# +
  #geom_sf(data = sativa, color = 'white', size = .05)

ggplot() +
  geom_stars(data = st_as_stars(irri) > 0.10) +
  scale_fill_viridis_d() +
  geom_sf(data = coasts, color = 'white') #+
   # geom_sf(data = sativa, color = 'white', size = .05)


chelsa
plot(irri > .3)
```

GFSAD30

### Chinese Vegetation atlas

```{r}
rice_ids <- read_excel('../../veget atlas china 2001 gis/veget atlas china 2001 code.xls') %>%
  filter(str_detect(tolower(`Vegetation formation and sub-formation`), 'rice'))
veg_atlas <- read_sf('../../veget atlas china 2001 gis/vegetation.shp') %>%
  select(VEGE_ID) %>%
  mutate(rice = if_else(VEGE_ID %in% rice_ids$新编号, TRUE, FALSE)) %>%
  group_by(rice) %>%
  summarise(geometry = st_union(geometry)) %>%
  st_transform(4326)

ggplot() +
  geom_sf(data = veg_atlas, lwd = 0.01, color = NA, aes(fill = rice))
```

```{r}
irri %>%
  crop(veg_atlas) %>%
  `>`(.5) %>%
  plot()
plot(irri > .3)


```

### Archaeological rice data

We used rice occurrence data from archaeological sites using version 2 of the Rice Archaeological Database \@[@silva2015]. The data span the period from xxx to yyy. A total of zzz sites are included in the database, mainly from eastern China, Japan, Korea, and southeast Asia. These are generally records of botanical remains thought to be *O. sativa japonica* from archaeological sites. Some of these occurrence were likely wild-type *O. rufipogon* instead based on their timing. We removed one such extremely early occurrence from xxx as a likely outlier.

Also cleaned data from [@gutaker2020]

Stepehens and fuller data ... but its pdf.

syntheis from [@longetal2022]

```{r arch-rice-data}
arch <- here('data/data-raw/Archaeological Rice Dataset.xlsx') %>%
  read_excel() %>%
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = 4326) %>%
  rename(age = `Est._Date_Median_BC`) %>%
  mutate(age = age - 1950) %>%
  st_crop(asia_bbox) %>%
  arrange(-age) %>%
  filter(age > -10000)

japan_arch <- read_csv('data/data-raw/sciadv.adc9171_data_s1.csv') %>%
  filter(USED == TRUE) %>% 
  st_as_sf(coords = c('Longitude', 'Laitude'), crs = 4326) # note "Laitude"

rice <- read_sf('data/data-raw/Rice Archaeological Database.kml') %>%
  st_zm()

long <- here('data/data-raw/ScienceDirect_files_13Feb2023_15-12-15/1-s2.0-S1040618221005577-mmc2.xlsx') %>%
  read_excel(skip = 11, n_max = 260) %>%
  rename(lon = `Longitude (°E)`,
         lat = `Latitude (°N)`) %>%
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>%
  st_crop(asia_bbox)

ggplot() +
      geom_sf(data = countries, color = 'white', lwd = 0.1) +
      geom_sf(data = arch, color = 'orange', size = 2.5) +
        geom_sf(data = long, color = 'yellow', size = 2) +
  geom_sf(data = rice, size = 1) +
    geom_sf(data = japan_arch, color = 'red', size = .5)

```

D'Alpoim Guedes and Bocinsky:

> One such useful dataset exists for the People's Republic of China---the China Vegetation Atlas, a 1:1,000,000 scale vegetation distribution map of China of data collected between the 1950s and 1980s ([*57*](https://www.science.org/doi/10.1126/sciadv.aar4491#core-R57))
>
> Because of the difficulty of accessing the China Vegetation Atlas in the United States, we have archived it in the Digital Archaeological Record (ID: 442484) at <https://doi.org/10.6067/XCV85B05BG>.
>
> The area where rice is grown in China expanded by 6.2 million hectares between 1949 and 1958 alone ([*58*](https://www.science.org/doi/10.1126/sciadv.aar4491#core-R58)). Between roughly 1960 and 1970, the introduction of dwarf varieties followed by hybrid rice further extended the area in which rice was cultivated. With the exception of a few cells, the distribution of rice is confined to the area south of the Yangtze River valley. Some low probability cells in Xinjiang, Inner Mongolia, and Heilongjiang represent expansions of the area under cultivation during the Great Leap Forward and following the introduction of new types of rice. Our analysis uses GDD values for nonhybrid and nondwarf varieties of rice. The extended range that post-1970 varieties are able to occupy may partially explain why a small percentage of rice occupies an area that is in lower niche probabilities ([Fig. 5](https://www.science.org/doi/10.1126/sciadv.aar4491#F5)).

doi:10.6067/XCV8MK6G05 -- crops from guedes and bocinnksy

**Prehistoric evolution of the dualistic structure mixed rice and millet farming in China<https://doi.org/10.1177/0959683617708455>**

## Climate data

### Contemporary climate

We used high-resolution gridded climate data from CHELSA V2 [@brun2022]. CHELSA is a quasi-mechanistic topo-climatic downscaling algorithm. It uses raw outputs from the ERA-5 reanalysis with additional bias correction by GPCC and xxx.CHELSA performs much better than other global gridded climate products like WorldClim or TerraClim, particularly in mountainous areas, and its use of high quality reanalysis data rather than unprocessed weather station data ensures further accuracy and internal consistency between the variables.

The monthly mean climatologies for precipitation and minimum and maximum temperature were post processed into the standard 19 bioclimatic variables, with additional variables relating to factors like soil moisture, growing season length, and humidity. These data span the period 1980-2010 at a 1km resolution. We aggregated the 1km data to 10km resolution to better sample the landscape-scale climate patterns and to ameliorate the false precision of using 1km climate data with uncertain occurrence geolocations.

```{r load-chelsa, cache = TRUE}
chelsa_files <- list.files('../../CHELSA_V2_bio_clim', 
                           full.names = TRUE)[c(2:20)]#, 31:33, 40:50, 52:59)]

chelsa_names <- chelsa_files %>% 
  str_split('_') %>% 
  map(~.x[5:7]) %>%
  map(~if_else(.x %in% c("1981-2010", "V.2.1.tif"), NA, .x)) %>%
  map_chr(str_flatten, collapse = '_', na.rm = TRUE)

chelsa <- terra::rast(chelsa_files) %>%
  aggregate(fact = 10, cores = available_cores, na.rm = TRUE) %>%
  crop(bbox) %>% # crop should come after, even if its faster to do the other way
  setNames(chelsa_names)

writeCDF(chelsa, here('data/data-derived/chelsa_10km.nc'), overwrite = TRUE, zname = 'var')
```

### Paleoclimate reconstructions

Including the global temperature reconstruction of [@10.5194/cp-18-2599-2022;\@10.5281/zenodo.6426332]. Downscaled climate models from Envirem and paleoclim.

```{r erb, fig.width = 6, fig.height = 5}
erb_rotated <- read_ncdf(here('data/data-raw/holocene_reconstruction.nc'), 
                              var = 'recon_tas_mean') %>%
                           st_set_crs(4326)
                         
times <- st_get_dimension_values(erb_rotated, 'ages')

floor_mil   = function(value){ return(value - value %% 1000) }
floor_cen   = function(value){ return(value - value %% 100) }

centuries <- floor_cen(1949.5 - times)
mil <- floor_mil(1949.5 - times)

erb <- erb_rotated %>%  
  as('SpatRaster') %>%
  rotate() %>%
  tapp(mil, fun = mean) %>%
  st_as_stars(crs = 4326) %>%
  st_set_dimensions('band', names = 'time', 
                    values = unique(mil) / 1000 - 1) %>%
  setNames('tas') %>%
  st_crop(asia_bbox) %>%
  mutate(tas = units::set_units(tas, degree_c)) %>%
  filter(time >= -8)

erb_decadal <- erb_rotated %>%  
  as('SpatRaster') %>%
  rotate() %>%
  st_as_stars(crs = 4326) %>%
  st_set_dimensions('band', names = 'time', 
                    values = -1 * (times + 0.5)) %>%
  setNames('tas') %>%
 st_crop(asia_bbox) %>%
  mutate(tas = units::set_units(tas, degree_c))

trace <- list.files('../../Data/TraCE-TREFHT', full.names = TRUE) %>%
  map(~read_ncdf(., var = 'TREFHT', eps = 0.01, make_time = FALSE) %>% 
        st_crop(asia_bbox)) %>%
  do.call(c, .) %>%
  mutate(TREFHT = units::set_units(TREFHT, 'degree_C')) %>%
  st_set_dimensions(names = c('x', 'y', 'time'))
length(st_get_dimension_values(trace, 'time'))

trace_mean_5bp_3bp <- trace %>% 
  filter(between(time, -5, -3)) %>%
  st_apply(1:2, mean) %>%
  st_warp(slice(erb, 'time', 1), use_gdal = TRUE, method = 'average')

plot(trace_mean_5bp_3bp)
```

Others? PMIP3/TRACE/CHELSA-TRACE

### Future climate projections

We acquired downscaled projections of future climate from the CMIP6 archive, also downscaled using the CHELSA algorithm [@brun2022].

```{r}

cmip6 <- list.files('~/Dropbox (UFL)/CHELSA_CMIP6/ssp585/', full.names = TRUE) %>%
  terra::rast() %>%
  aggregate(fact = 10, mean, cores = available_cores) %>%
  setNames(chelsa_names) %>%
  terra::crop(bbox)

cmip6[['bio3']] <- cmip6[['bio3']] * 100

writeCDF(cmip6, here('data/data-derived/chelsa_cmip6_10km.nc'), overwrite = TRUE, zname = 'var')

plot(cmip6[[1:16]])
plot(cmip6[[16:19]])
```

### Sample points

```{r}
n_background <- 10000
```

We thinned the occurrence data to minimize influences from sampling biases. We select one sample per 10km grid in the predictor data [@dismo]. Because we do not have true absence data for past and present rice occurrences, we generated `n_background` latitude-weighted random background points on land surfaces. This allows us to estimate the relative suitability for the given crop with respect to the global climatic baseline.

We sample everywhere to get background pionts, and do not ignore places with occurrences.
threshold of 0.1 to 0.2 from Watson et al 2015 and singh et al 2017

```{r}

set.seed(1234567)
dat <- spatSample(irri, 20000, na.rm = TRUE, as.points = TRUE) %>%
  st_as_sf() %>%
  transmute(presence = as.numeric(`asia-rice-extent` > 0.1)) %>%
  bind_cols(., terra::extract(chelsa, ., ID = FALSE)) %>%
  mutate(presence = factor(presence, levels = c(1, 0)))
  
ggplot(dat) +
  geom_sf(data = countries, color = NA) +
  geom_sf(size = 0.1, aes(color = factor(presence, levels = c(0, 1)))) +
  scale_color_manual(values = c('black', 'red')) +
  theme_minimal()

```

```{r}
plot(irri)
plot(chelsa)
cmip6
save(dat, erb, erb_decadal, trace_mean_5bp_3bp, arch, long, 
     file = 'data/data-derived/data_prepped.RData')
```
