---
title: "Online Methods"
format: html
editor: visual
bibliography: references_methods.bib
---

```{r setup}
# analysis packages
library(stars) # spatio-temporal raster processing
library(sf)
library(tidyverse)
library(terra)
library(here) # cross-platform directory structures
library(readxl)
library(rcarbon)
library(rsample) # bootstraps
library(eks)
library(units)
library(rnaturalearth)
library(patchwork) # multi-panel plots
library(units)

bbox <- terra::ext(60, 150, -20, 50)
bbox_world <- raster::extent(-130, 155, -40, 60)  # global
asia_bbox_sf <- st_bbox(c(xmin = 60, xmax = 150, ymin = -20, ymax = 50), crs = 4326)
world_bbox_sf <- st_bbox(c(xmin = -130, xmax = 155, ymin = -40, ymax = 60), crs = 4326)

theme_set(theme_bw())

# get country boundaries shapefiles for plotting
sf_use_s2(FALSE)
countries <- ne_countries(returnclass = "sf", scale = 'large') %>% 
  st_crop(asia_bbox_sf)
coasts <- ne_coastline(returnclass = 'sf') %>%
  st_crop(asia_bbox_sf)
coasts_world <- ne_coastline(returnclass = 'sf') %>% 
  st_crop(world_bbox_sf)
countries_world <- ne_countries(returnclass = "sf", scale = 'large') %>% 
  st_crop(world_bbox_sf)
sf_use_s2(TRUE)

# parallel processing
available_cores <- parallel::detectCores(logical = TRUE)
```

# Methods

## Climate Data

We used high-resolution gridded climate data from version 2.1 of the CHELSA product [@karger2017, @Karger2018, @brun2022, @brun]. CHELSA incorporates bias-corrected outputs from the ERA-5 reanalysis with high-resolution terrain data using mechanistic relationships between local climate and terrain. Compared to other global gridded climate products, CHELSA offers superior performance in mountainous regions, and its reliance on high-quality reanalysis data instead of raw weather station data ensures greater accuracy and internal consistency among climate variables.

### Contemporary Climate Data

For present-day observed climate, we used the CHELSA V2.1 product spanning the period 1981-2010 at a 1km resolution. We further aggregated the native 1km data to 5km and 10km grids to assess the sensitivity of our results to the scale of the analysis, given the variable spatial support of the contemporary rice extent data. In all cases we used standard temperature indicators used in ecological niche modeling studies [@brun], derived from monthly climatologies of minimum and maximum temperature, which collectively represent annual means, monthly extremes, and seasonality.

First we download the CHELSA data if they are not already present in the data/ folder.

```{r download-chelsa}
# download contemporary CHELSA temperature rasters
url_base <- 'https://os.zhdk.cloud.switch.ch/envicloud/chelsa/chelsa_V2/GLOBAL/climatologies/1981-2010/bio/'
filenames <- c('CHELSA_bio1_1981-2010_V.2.1.tif', 
               'CHELSA_bio5_1981-2010_V.2.1.tif', 
               'CHELSA_bio10_1981-2010_V.2.1.tif',
               'CHELSA_pet_penman_mean_1981-2010_V.2.1.tif') # PET used as land mask

walk(filenames, function(x) {
  target_file <- here('data/data-raw', x)
  if (!file.exists(target_file)) {
    download.file(paste0(url_base, x), target_file)
  }
})
```

Then read them in using `terra::rast()`.

```{r load-chelsa}
chelsa_1km <- here('data/data-raw', filenames[-4]) |>
  rast() |>
  setNames(c('bio1', 'bio5', 'bio10'))

# get the PET map to use as a land mask on the CHELSA grid
chelsa_mask <- here('data/data-raw', filenames[4]) |>
  rast() %>%
  crop(bbox_world)
```

Regrid to 5 and 10km resolution.

```{r regrid-chelsa}
chelsa_5km <- aggregate(chelsa_1km, fact = 5, cores = available_cores, na.rm = TRUE)
chelsa_10km <- aggregate(chelsa_1km, fact = 10, cores = available_cores, na.rm = TRUE)
```

Make additional copies cropped to Asia.

```{r}
chelsa_1km_asia <- crop(chelsa_1km, bbox)
chelsa_5km_asia <- crop(chelsa_5km, bbox)
chelsa_10km_asia <- crop(chelsa_10km, bbox)
```

Check the range of values at different resolutions and extents. The upper temperatures don't appear to be very sensitive to resolution, which is good.

```{r eval = FALSE}
list(chelsa_1km, 
     chelsa_5km, 
     chelsa_10km, 
     chelsa_1km_asia, 
     chelsa_5km_asia, 
     chelsa_10km_asia) %>%
  map(minmax, compute = TRUE)
```

```{r eval = FALSE}
# may delete?
writeCDF(chelsa_5km, here('data/data-derived/chelsa_5km.nc'), overwrite = TRUE, zname = 'var')
writeCDF(chelsa_10km, here('data/data-derived/chelsa_10km.nc'), overwrite = TRUE, zname = 'var')
writeCDF(chelsa_5km_asia, here('data/data-derived/chelsa_5km_asia.nc'), overwrite = TRUE, zname = 'var')
writeCDF(chelsa_10km_asia, here('data/data-derived/chelsa_10km_asia.nc'), overwrite = TRUE, zname = 'var')
```

### Paleoclimate reconstructions

Past climate data were derived from the CHELSA-TraCE21k product, a downscaled version of TraCE-21k simulation of the CCSM3 climate model spanning the last 21,000 years, at 100 year intervals [@karger2023, @He2011]. This product uses the older CHELSA V1.2 algorithm, along with a trend-preserving bias correction and topographic correction for shifting ice sheets across the deglacial period.

```{r chelsa-trace}
# this is nor portable nor easily downloadable, will have to do something to enable reproducibility
trace_order <- list.files('~/Dropbox (UFL)/Data/CHELSA/chelsa_trace/bio01', 
                          full.names = FALSE) %>%
  str_sub(23, -10) %>% 
  as.numeric() %>% 
  order()

trace_tmp <- list.files('~/Dropbox (UFL)/Data/CHELSA/chelsa_trace/bio01', 
                        full.names = TRUE)[trace_order] %>%
  read_stars(along = 'time')

trace_tmax <- list.files('~/Dropbox (UFL)/Data/CHELSA/chelsa_trace/bio05', 
                         full.names = TRUE)[trace_order] %>%
  read_stars(along = 'time') 

trace_twarm <- list.files('~/Dropbox (UFL)/Data/CHELSA/chelsa_trace/bio10', 
                         full.names = TRUE)[trace_order] %>%
  read_stars(along = 'time') 

chelsa_trace <- c(trace_tmp, trace_tmax, trace_twarm) %>%
  st_set_dimensions('time', values = seq(-12, 0, 0.1) * 1000, names = 'time') %>%
  setNames(c('MAT', 'tmax', 'twarm'))

# test of using vsicurl to get data w/out download
test <- rast('/vsicurl/https://os.zhdk.cloud.switch.ch/envicloud/chelsa/chelsa_V1/chelsa_trace/bio/CHELSA_TraCE21k_bio01_-100_V1.0.tif')
plot(test)
```

```{r erb, eval = FALSE}
# may not be necessary
erb <- here('data/data-raw/holocene_reconstruction.nc') %>% 
  read_ncdf(var = 'recon_tas_ens') %>%
  st_set_crs(4326) %>%
  st_crop(asia_bbox_sf)

times <- st_get_dimension_values(erb, 'ages')

floor_cen <- function(value){ return(value - value %% 100) }

centuries <- floor_cen(1949.5 - times)
erb_decadal <- erb %>%  
  as('SpatRaster') %>%
  rotate() %>%
  st_as_stars(crs = 4326) %>%
  st_set_dimensions('band', names = 'time', 
                    values = -1 * (times + 0.5)) %>%
  setNames('tas') %>%
  st_crop(asia_bbox) %>%
  mutate(tas = set_units(tas, degree_c))
```

### Future climate projections

Future climate model ensembles were derived from phase six of the Coupled Model Intercomparison Project (CMIP6) [@eyring2016], using the subset of bias-corrected models and scenarios used in phase 3b of the Inter-Sectoral Impact Model Intercomparison Project (ISIMIP) [@lange2019], bilinearly interpolated to the CHELSA V2.1 basemap using the delta change approach [@brun, @brun2022].

```{r}
#delete?
cmip6_26 <- list.files('~/Dropbox (UFL)/CHELSA_CMIP6/ssp126/', full.names = TRUE) %>%
  terra::rast() %>%
  setNames(chelsa_names[2:20]) %>%
  .[[c('bio1', 'bio5', 'bio10')]] %>%
  aggregate(fact = 5, mean, cores = available_cores) %>%
  terra::crop(bbox)

cmip6_70 <- list.files('~/Dropbox (UFL)/CHELSA_CMIP6/ssp370/', full.names = TRUE) %>%
  terra::rast() %>%
  setNames(chelsa_names[2:20]) %>%
  .[[c('bio1', 'bio5', 'bio10')]] %>%
  aggregate(fact = 5, mean, cores = available_cores) %>%
  terra::crop(bbox)

cmip6_85 <- list.files('~/Dropbox (UFL)/CHELSA_CMIP6/ssp585/', full.names = TRUE) %>%
  terra::rast() %>%
  setNames(chelsa_names[2:20]) %>%
  .[[c('bio1', 'bio5', 'bio10')]] %>%
  aggregate(fact = 5, mean, cores = available_cores) %>%
  terra::crop(bbox)

writeCDF(cmip6_85, here('data/data-derived/chelsa_cmip6_85_5km.nc'), 
         overwrite = TRUE, zname = 'var')
writeCDF(cmip6_70, here('data/data-derived/chelsa_cmip6_70_5km.nc'), 
         overwrite = TRUE, zname = 'var')
writeCDF(cmip6_26, here('data/data-derived/chelsa_cmip6_26_5km.nc'), 
         overwrite = TRUE, zname = 'var')
```

#### Country level summaries

```{r}
countries_sub <- countries %>% 
  filter(name %in% c('China', 'India', 'Indonesia', 'Bangladesh', 'Vietnam', 
                     'Thailand', 'Philippines', 'Myanmar', 'Pakistan', 'Japan', 
                     'South Korea', 'Cambodia', 'Laos', 'Nepal', 'Malaysia'))
         
obs_test <- chelsa_obs %>%
  split('variable') %>%
  mutate(bio1 = bio1 > drop_units(bio1_limit),
         bio10 = bio10 > drop_units(bio10_limit),
         bio5 = bio5 > drop_units(bio5_limit)) %>%
  rename(`Mean annual temperature` = bio1,
         `Max temperature of warmest quarter` = bio10,
         `Max temperature of warmest month` = bio5) %>%
  merge(name = 'variable') %>%
  st_crop(st_bbox(countries_sub)) %>%
  st_downsample(5) %>%
  setNames('sum')

plot(obs_test)

test <- cmip6 %>%
  split('variable') %>%
  mutate(bio1 = bio1 > drop_units(bio1_limit),
         bio10 = bio10 > drop_units(bio10_limit),
         bio5 = bio5 > drop_units(bio5_limit)) %>%
  rename(`Mean annual temperature` = bio1,
         `Max temperature of warmest quarter` = bio10,
         `Max temperature of warmest month` = bio5) %>%
  merge(name = 'variable')


plot(countries['name'] )

test1 <- st_crop(test, st_bbox(countries_sub)) %>%
  st_downsample(5) %>%
  setNames('sum')

areas <- st_area(test1) %>% drop_units()
plot(areas)
plot(obs_test)

test2 <- test1 * areas
plot(test2)

obs_weight <- obs_test * areas
plot(obs_weight, downsample = 0)

test3 <- aggregate(test2, by = st_geometry(countries_sub), FUN = sum, na.rm = TRUE) %>%
  as_tibble() %>%
  select(-geometry) %>%
  mutate(name = rep(countries_sub$name, length.out = n()))



test4 <- aggregate(areas, by = st_geometry(countries_sub), FUN = sum, na.rm = TRUE) %>%
  as_tibble() %>%
  select(-geometry) %>%
  mutate(name = countries_sub$name)

obs_ext <- aggregate(obs_weight, by = st_geometry(countries_sub), FUN = sum, na.rm = TRUE) %>%
  as_tibble() %>%
  select(-geometry) %>%
  mutate(name = rep(countries_sub$name, length.out = n())) %>%
  left_join(test4) %>%
   mutate(percent = round(sum / area * 100),
          ssp = 'present')


df <- left_join(test3, test4) %>%
  mutate(percent = round(sum / area * 100)) %>%
  #select(-sum, -area) %>%
  group_by(name, variable, ssp) %>%
  summarise(percent = mean(percent, na.rm = TRUE),
            sum = mean(sum, na.rm = TRUE),
            area = mean(area, na.rm = TRUE)) %>%
  ungroup() %>%
  bind_rows(obs_ext)

saveRDS(df, 'data/data-derived/country_stats.rds')

```

### Loading Preprocessed data

```{r}
rast(here('data/data-derived/chelsa_cmip6_85_5km.nc')) %>% setNames(chelsa_names[2:20]) %>% plot
writeCDF(cmip6_70, here('data/data-derived/chelsa_cmip6_70_5km.nc'), 
         overwrite = TRUE, zname = 'var')
writeCDF(cmip6_26, here('data/data-derived/chelsa_cmip6_26_5km.nc'), 
         overwrite = TRUE, zname = 'var')
```

## Contemporary Rice Distribution Data

We collected rice occurrence data from a variety of sources combining information from satellites, administrative statistics, and herbarium collections. Our goal was to assess the sensitivity of our results to various modes of data collection, sampling, spatiotemporal scale, and other potential sources of bias.

### Point Occurrences

Geolocated, point-based occurrence records for rice and its wild progenitor synthesized from previous studies [@civán2018; @yang2022; @ramirez-villegas2022], originally sourced from GBIF, the Rice Haplotype Map project, and other datasets based on herbarium specimens or germplasm samples from international genebank databases. Given their direct identification, these occurrence records generally offer greater reliability than area-averaged crop occurrences derived from satellites and sub-national statistics. Nonetheless, they are susceptible to spatial sampling bias. For instance, regions like China are underrepresented in GBIF in terms of sampling effort compared to neighboring countries with similar geographical extent, and herbarium collections may more accurately sample upland rice varieties at the expense of larger paddy fields. After creating the full combined datasets, geolocations were checked for anomalous entries then thinned to a uniform grid to minimize irregular spatial sampling.

We extracted the contemporary CHELSA climate data at each set of occurrence points for each data type to calculate temperature distributions and quantiles. We explored various combinations of grid/point resolution for the climate and occurrence datasets from 1-10km, but found this did not impact the upper temperature threshold estimates.

#### GBIF/Herbaria Records

```{r gbif}
occ <- here('data/data-raw/Datasets of occurrence records of rice and its wild progenitor.xlsx')
 
if (!file.exists(occ)) download.file('https://figshare.com/ndownloader/files/33903758', occ)

rufipogon <- read_excel(occ, skip = 6715) %>%
  select(-x, -`the wild progenitor`) %>%
  st_as_sf(coords = 2:1, crs = 4326) %>%
  st_crop(asia_bbox_sf) %>% # remove south american obs, likely different species
  mutate(rice = 'present')

sativa <- read_excel(occ, n_max = 6714) %>%
  remove_missing() %>%
  select(-x, -Rice) %>%
  st_as_sf(coords = 2:1, crs = 4326) %>%
  mutate(rice = 'present') %>%
  select(-continent)

ggplot() +
  geom_sf(data = countries_world, color = 'white') +
  geom_sf(data = sativa, size = 0.1, color = 'black') +
  geom_sf(data = rufipogon, color = 'green', size = 0.1) +
  labs(title = "Rice occurence data", 
       subtitle = "O. sativa (black), O. rufipogon (green)", 
       caption = 'source: Yang et al. 2022, via GBIF, CHV') 
```

#### Genbank accessions

```{r}
gen_occs_data <- here('data/data-raw/12862_2018_1180_MOESM1_ESM.xls')
if (!file.exists(gen_occs_data)) download.file('https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5913815/bin/12862_2018_1180_MOESM1_ESM.xls', gen_occs_data)

gen_occs <- gen_occs_data %>%
  read_excel(skip = 2) %>%
  mutate(lat = parse_double(`Latitude*†`),
         lon = parse_double(`Longitude*†`),
         type = `Species/ecotype*`) %>%
  filter(!(is.na(lon) | is.na(lat))) %>%
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>%
  select(type) %>%
  filter(type %in% c('indica', 'O. rufipogon', 'temperate japonica'))

ggplot() +
  geom_sf(data = countries, color = 'white') +
  geom_sf(data = gen_occs, aes(color = type),
          size = 1) +
  labs(title = "Rice occurence data", 
       subtitle = "From genetic assessions", 
       caption = 'source: Civáň and Brown 2018')
```

#### Combined

Thin the two sets of occurrence records to a 1km grid and combine. So let's combine this with the GBIF occurrence above. It definitely helps us sample the temperate varieties better, but its still a minor influence relative to the numbers of gbif points. also include These are predictions from a classifier that use climate data, so not exactly useful here but interesting to see. Aus is grown in summer before monsoon and harvested in fall -- not great quality but as a backup

```{r}
rufip_thin <- dismo::gridSample(
  st_coordinates(rufipogon), 
  r = chelsa_mask) %>% 
  as_tibble() %>%
  st_as_sf(coords = c('X', 'Y'), crs = 4326) %>%
  mutate(presence = 1,
         type = 'rufipogon')

sativa_thin <- dismo::gridSample(
  st_coordinates(sativa), 
  r = chelsa_mask) %>% 
  as_tibble() %>%
  st_as_sf(coords = c('X', 'Y'), crs = 4326) %>%
  mutate(presence = 1,
         type = 'sativa')

gbif_thin <- bind_rows(sativa_thin, rufip_thin)

gen_thinned <- gen_occs %>%
  group_nest(type) %>%
  mutate(data = map(data, 
                    ~dismo::gridSample(st_coordinates(.x), 
                                       r = chelsa_mask) %>%
                      as_tibble())
  ) %>%
  unnest(data) %>%
  st_as_sf(coords = c('X', 'Y'), crs = 4326) %>%
  mutate(presence = 1)

comb <- bind_rows(gen_thinned, gbif_thin)

ggplot() +
  geom_sf(data = countries, color = 'white') +
  geom_sf(data = st_crop(comb, asia_bbox_sf), 
          aes(color = type),
          size = .5) +
  geom_sf(data = coasts)
```

```{r}
pred_var <- 'data/data-raw/Ramirez-Villegas/Sup_table_3_per_crop/rice (asia).csv' %>%
  read_csv() %>%
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = 4326) %>%
  select(ensemble)

ggplot(pred_var, aes(color = ensemble)) +
  geom_sf(size = 1, alpha = 0.5) +
  scale_color_brewer(palette = 'Spectral') +
  geom_sf(data = coasts, color = 'black')

comb_final <- comb %>%
  filter(!(type %in% c('O. rufipogon', 'rufipogon'))) %>%
  bind_rows(pred_var) %>%
  st_coordinates() %>%
  dismo::gridSample(r = chelsa_mask) %>% 
  as_tibble() %>%
  st_as_sf(coords = c('X', 'Y'), crs = 4326) %>%
  mutate(presence = 1)

ggplot() +
  geom_sf(data = comb_final %>% st_crop(asia_bbox_sf), size = .5) +
  geom_sf(data = coasts)
```

```{r}
occ_dat <- terra::extract(chelsa_1km, comb_final, ID = FALSE) %>%
  bind_cols(comb_final, .)

ggplot(occ_dat) +
  geom_sf(data = countries_world, color = NA) +
  geom_sf(size = 0.1) +
  theme_minimal()
```

### Satellite-derived occurrences

#### International Rice Research Institute

Satellite-based estimates of lowland rice extent in Asia from the International Rice Research Institute [@nelson2015]. This dataset employs high-resolution (500m) presence-absence markers from MODIS observations and offers relatively uniform sampling across both temperate and tropical regions. It provides a more objective approach than spatially biased occurrence records. However, its coverage is limited to East and Southeast Asia and it may poorly distinguish intercropped wheat and rice in Northeast China and natural wetlands and paddy rice cultivation in Indonesia. To minimize such sampling issues, we aggregated the 500m data into 5km grid cells, dropping occurrences with less than 10% coverage to minimize false positives from low-pixel observations. Subsequent analyses of these data proved robust to the exact resolution and coverage threshold used.

```{r fig.width=6, fig.height=5}
irri <- rast(here('data/data-raw/IRRI Asia Rice Extent Map/asia-rice-extent.tif')) %>%
  aggregate(fact = 10) %>% # from 500m to 5km
  mask(., resample(chelsa_mask, .)) %>%
  setNames('extent')

ggplot() +
  geom_stars(data = st_as_stars(irri)) +
  scale_fill_viridis_c(na.value = 'NA') +
  coord_quickmap()

ggplot() +
  geom_stars(data = st_as_stars(irri) > 0.10) +
  scale_fill_manual(values = c('grey', 'red'), na.value = NA, guide = FALSE) +
  labs(title = 'Satellite-based lowland rice extent', caption = 'Nelson and Gumma (2015) "A map of lowland rice extent in the major rice growing countries of Asia"', x = '', y = '')
```

```{r}
irri_occ <- irri %>%
  as.data.frame(xy = TRUE) %>%
  st_as_sf(coords = c('x', 'y'), crs = 4326) %>%
  filter(extent > 0.10) %>%
  bind_cols(., terra::extract(chelsa_5km, ., ID = FALSE))

ggplot(irri_occ) +
  geom_sf(data = countries, color = NA) +
  geom_sf(size = 0.1, alpha = 0.1) +
  scale_color_manual() + 
  theme_minimal() 
```

#### Monfreda and Ramankutty

Estimates of paddy rice harvested areas around the year 2000 [@monfreda2008]. This dataset, integrates satellite-based estimates of cropland with sub-national statistics for rice harvested areas. It utilizes geospatial cropland maps to downscale harvest area and yield census data and offers global coverage at approximately 10km resolution. Countries that lack detailed administrative data at the subnational level, such as Laos and Kazakhstan, can exhibit overly smoothed areas. The use of harvested area as a metric can be misleading in regions with multiple annual harvests, leading to double or triple counting.

```{r}
# this is just "paddy rice" according to documentation
monfreda_fraction <- geodata::crop_monfreda('rice', 
                                            var = 'area_f', 
                                            here('data/data-raw')) %>%
  crop(., resample(chelsa_mask, .), mask = TRUE) %>%
  clamp(upper = 1, values = TRUE) %>% # fraction can be greater than 1 because of multi cropping
  st_as_stars() %>%
  st_crop(world_bbox_sf) %>%
  setNames('area_f')

ggplot() +
  geom_stars(data = monfreda_fraction) +
  scale_fill_viridis_c(na.value = NA, trans = 'log') +
  geom_sf(data = coasts_world, color = 'black') 

ggplot() +
  geom_stars(data = monfreda_fraction > 0.01) +
  scale_fill_manual(values = c('grey', 'red'), na.value = NA, guide = FALSE) +
  geom_sf(data = coasts_world, color = 'black') 
```

```{r}
monfreda_occ <- monfreda_fraction %>%
  rast() %>%
  clamp(lower = 0.05, values = FALSE) %>% 
  as.data.frame(xy = TRUE) %>%
  st_as_sf(coords = c('x', 'y'), crs = 4326) %>%
  mutate(presence = 1) %>%
  dplyr::select(presence, extent = area_f) %>%
  bind_cols(., terra::extract(chelsa_10km, ., ID = FALSE))

ggplot(monfreda_occ) +
  geom_sf(data = countries_world, color = NA) +
  geom_sf(size = 0.1) +
  theme_minimal() 
```

```{r fig.asp=0.4, fig.width = 10}
a <- ggplot(occ_dat) +
  geom_sf(data = countries_world, color = NA) +
  geom_sf(size = 0.1) +
  theme_minimal()

b <- ggplot(irri_occ) +
  geom_sf(data = countries, color = NA) +
  geom_sf(size = 0.1) +
  theme_minimal() 

c <- ggplot(monfreda_occ) +
  geom_sf(data = countries_world, color = NA) +
  geom_sf(size = 0.1) +
  theme_minimal() 

b + (a / c) + plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'A', tag_suffix = ')')
```

```{r}
save(irri_occ, monfreda_occ, occ_dat,
     file = here('data/data-derived/occurrence_data.RData'))
```

## Archaeological Data

We used past rice occurrence data sourced from archaeological sites, as synthesized in @Guedes2018 and @long2022 and primarily derived from version 2 of the Rice Archaeological Database [@silva2015]. We also included observations from @crema2022 to increase data coverage in Japan. These records are typically of botanical remains, believed to represent O. sativa japonica from these archaeological sites, with less intensive sampling of indica varieties from northern India. However, based on their chronology, some occurrences might pertain to the wild-type O. rufipogon or O. nivara. 

```{r}
gb2018 <- here('data/data-raw/guedesbocinsky2018_crops_across_eurasia.xlsx') %>%
  read_excel() %>%
  filter(is.na(`Exclude?`) & (!is.na(Rice) | !is.na(`Rice (wild)`))) %>% # just rice
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = 4326) %>%
  select(labcode = `Lab sample identifier`, 
         site = Site, 
         Period, 
         Notes, 
         Material, `14C date on cereal?`, 
         age_lower = `Age range lower (BP)`, 
         age_upper = `Age range upper (BP)`, 
         C14Age = `14C age BP`, 
         C14AgeError = `1-sigma uncertainty`, 
         Reference, 
         `Rice (wild)`) %>%
  filter(site != 'Huizui East', # duplicated with diff name in long
        is.na(labcode) | labcode != 'Beta- 378858') %>% # incorrect date per original source and long
  mutate(source = 'gb')

long <- here('data/data-raw/ScienceDirect_files_13Feb2023_15-12-15/1-s2.0-S1040618221005577-mmc2.xlsx') %>%
  read_excel(skip = 11, n_max = 260) %>%
  rename(lon = `Longitude (°E)`,
         lat = `Latitude (°N)`) %>%
  st_as_sf(coords = c('lon', 'lat'), crs = 4326) %>%
  st_crop(asia_bbox_sf) %>% # only sites in Asia
  rename(site = `Archaeological site`,  
         C14Age = `Uncalibrated radiocarbon age (14C BP)`, 
         cal_age = `Calibrated median (BCE/CE)`, 
         labcode = `Lab ID`,
         C14AgeError = `Radiocarbon dating uncertainty (yr)`) %>%
  mutate(site = if_else(site == 'Khao Sam Kaeo', 'Khao Sam Kheo', site),
         site = if_else(site == 'Ter', 'Ter (Thair)', site)) %>%
  filter(!(labcode %in% gb2018$labcode)) |>
  mutate(source = 'long')

long_filter <- long %>%
  bind_rows(gb2018) %>%
  select(site, C14Age) %>%
  st_drop_geometry() %>%
  remove_missing() %>%
  filter(duplicated(.))

japan_arch <- read_csv('data/data-raw/sciadv.adc9171_data_s1.csv') %>% # two rows ohave commas, not important
  filter(USED == 'TRUE') %>% 
  st_as_sf(coords = c('Longitude', 'Laitude'), crs = 4326) %>% # "Laitude"
  rename(site = SiteName_en, labcode = LabCode) |>
  mutate(source = 'japan')

rad <- read_excel('data/data-raw/Rice_RAD3_OWCAD v0_9977.xlsx') %>%
  st_as_sf(coords = c('Longitude', 'Latitude'), crs = 4326) %>%
  filter(Oryza != 'Org') |>
  mutate(age_upper = -1 * (as.numeric(`Finish Date BC/AD`) - 1950), # introduces NA's to some rows without upper/lower dates (which is OK)
         age_lower = -1 * (as.numeric(`Start Date BC/AD`) - 1950)) |>
  filter(`GeoRef Quality` > 1) |> # only sites with < 10-20km location accuracy
  select(site = Site, age_lower, age_upper) %>%
  st_filter(st_union(gb2018), .predicate = not_near, dist = 1000) |>
  st_filter(st_union(japan_arch), .predicate = not_near, dist = 1000) |>
  st_filter(st_union(long), .predicate = not_near, dist = 1000) |>
  st_crop(asia_bbox_sf) %>% # only sites in Asia
  filter(!((site %in% gb2018$site) | (site %in% long$site) | (site %in% japan_arch$site))) %>%
  filter(!is.na(age_lower)) |>
  mutate(source = 'rad')

c14_cleaned <- bind_rows(
  anti_join(long, long_filter),
  filter(gb2018, !is.na(C14Age)), 
  japan_arch) %>%
   mutate(calib = ifelse(st_coordinates(geometry)[,2] > 0,
                         "intcal20",
                         "shcal20")) %>%
  select(site, C14Age, C14AgeError, calib, source) %>%
  arrange(site, C14Age)

cal <- calibrate(c14_cleaned$C14Age, 
                 c14_cleaned$C14AgeError, 
                 calCurves = c14_cleaned$calib,
                verbose = FALSE) 

c14_cleaned <- c14_cleaned %>%
  mutate(med_age = medCal(cal),
         id = 1:n()) %>%
  select(site, id, med_age, source)

phases_cleaned <- gb2018 %>% 
  filter(is.na(C14Age), !is.na(age_lower)) %>%
  select(site, age_lower, age_upper, source) %>%
  bind_rows(rad) %>%
  # ~6 sites have switched upper and lower ages
  mutate(temp_lower = pmax(age_lower, age_upper),
         age_upper = pmin(age_lower, age_upper),
         age_lower = temp_lower) %>%
  rowwise() %>%
  mutate(med_age = median(c(age_lower, age_upper)), .before = age_lower) %>%
  ungroup() %>%
  select(-temp_lower) |>
  filter(med_age <= 12000) |> # removes dates older than 12ka, 2x from Diaotonghuan cave and 1 each from Xianrendong, Yuchanyan, Sorori, and DG9605 core
  mutate(id = 1:n(),
         id = id + nrow(c14_cleaned)) 

arch_dat <- bind_rows(c14 = c14_cleaned,
                      period = phases_cleaned,
                      .id = 'type') %>%
  mutate(across(contains('age'), ~. * -1))

rm(long_filter, japan_arch, long, gb2018, rad)
```
After data harmonization—which involved eliminating potential outliers, rectifying misclassifications, and removing duplicated site data—we were left with a comprehensive dataset of `r nrow(arch_dat)` dates from `r length(unique(arch_dat$site))` archaeological sites. These datasets comprise a mixture of direct radiocarbon dates on rice remains, alongside dates from associated contextual materials and ranges anchored in prevailing archaeological eras. We employed the Intcal20 calibration curve for recalibrating all radiocarbon dates, barring a single site in the southern hemisphere where we utilized SHcal20.

### Extracting paleoclimate data

We then extracted temperature variables from the CHELSA-TraCE21k v1.0 dataset at each sampled location in time and space. Finally, we constructed unique kernel density estimates of the temperature distributions at each rice occurrence point for every bootstrap replicate and temperature variable.

```{r}
arch_trace <- arch_dat %>%
  st_extract(chelsa_trace, ., time_column = 'med_age', interpolate_time = TRUE) %>%
  st_drop_geometry() %>%
  bind_cols(select(arch_dat, -c(med_age, age_lower, age_upper)), .) %>%
  remove_missing() # this shouldn't remove anything
```

```{r}
saveRDS(arch_trace, here('data/data-derived/arch_trace.rds'))
```


## Genetic Data

```{r}
rice_accessions <- list(indica = 'data/data-raw/indica_accessions.csv',
                        japonica = 'data/data-raw/japonica_accessions.csv') %>%
  map(read_csv) %>%
  map(remove_missing) %>% # missing points data in Taiwan
  map_dfr(st_as_sf, coords = c('LON', 'LAT'), crs = 4326, .id = 'type')


rice_accessions %>%
  select(type) %>%
  plot()
```

```{r}
gen_mod <- extract(chelsa_1km, rice_accessions, ID = FALSE) %>%
  bind_cols(rice_accessions) %>%
  select(ID, type, bio1:bio10) %>%
  write_csv(here('data/data-derived/rice_temperatures_present.csv'))

gen_future <- cmip6 %>%
   st_extract(rice_accessions) %>%
   as_tibble() %>%
   bind_cols(map_dfr(1:45, ~rice_accesssions)) %>%
   select(ID, type, ssp, model, variable, temperature) %>%
   pivot_wider(names_from = variable, values_from = temperature) %>%
     write_csv(here('data/data-derived/rice_temperatures_future.csv'))

gen_past <- chelsa_trace %>%
  st_extract(rice_accessions) %>%
  st_apply(1, max) %>%
  as_tibble() %>%
  bind_cols(rice_accessions) %>%
  select(ID, type, bio1 = MAT, bio5 = tmax, bio10 = twarm) %>%
  write_csv(here('data/data-derived/rice_temperatures_past.csv'))

bind_rows(gen_past, gen_mod, gen_future, .id = 'time') %>%
  pivot_longer(bio1:bio10) %>%
  ggplot(aes(value, color = time)) +
  facet_wrap(~name, nrow = 3) +
  geom_density()
```

## Bootstrapping Archaeological Dates

To account for chronological uncertainty, we generated 5,000 bootstrap replicates, sampling from the radiocarbon dates' posterior density distribution and a uniform density for the archaeological phase dates.

```{r}
#binsense(cal, c14_cleaned$site, h = c(0, 100, 200), timeRange = c(10000, 0))
#rice_bins <-  binPrep(sites = c14_cleaned$site, ages = c14_cleaned$C14Age, h = 100)
# should do southern hemisphere curve for other dates? its just one date
#bin_pts <- c14_cleaned %>%
#  mutate(bin = rice_bins) %>%
#  select(bin) %>%
#  group_by(bin) %>%
#  slice(1) %>%
#  ungroup()
sampler_c14 <- function(splits) {
  analysis(splits) %>%
    mutate(time = -1 * map_dbl(cal_grid, ~sample(.x$calBP, size = 1, prob = .x$PrDens))) %>%
    select(id, time)
}

sampler_phase <- function(splits) {
   analysis(splits) %>%
    mutate(time = -1 * map2_dbl(age_lower, age_upper, # upper needs to be min not max
                               ~round(runif(1, min = .y, max = .x)))) %>%
    select(id, time)
}

nsim <- 5000
set.seed(5678)
c14_splits <- c14_cleaned %>%
  select(site, id, med_age) %>%
  mutate(cal_grid = cal$grids, .before = geometry) %>%
  group_bootstraps(group = site, times = nsim)

phase_splits <- phases_cleaned %>%
  select(site, id, age_lower, age_upper) %>%
  group_bootstraps(group = site, times = nsim)

boot_joined <- list(c14 = map_dfr(c14_splits$splits, sampler_c14, .id = 'rep'),
                    phase = map_dfr(phase_splits$splits, sampler_phase, .id = 'rep')) %>%
  bind_rows(.id = 'type') %>%
  mutate(time = time)
```

Sample CHELSA at bootstrapped points in space-time.
```{r}
trace_boot <- boot_joined %>%
  st_extract(chelsa_trace, ., time_column = 'time', interpolate_time = TRUE) %>%
  st_drop_geometry() %>%
  bind_cols(st_drop_geometry(boot_joined) %>% select(-time), .) %>%
  remove_missing() # this shouldn't remove anything
```

```{r}
saveRDS(trace_boot, 'data/data-derived/trace_boot.rds')
```

```{r}
trace_boot %>%
  filter(time <= -2000) %>%
  select(rep, MAT:twarm) %>%
  pivot_longer(MAT:twarm) %>%
  group_by(rep, name) %>%
  tidy_kde() %>%
ggplot(aes(value, estimate)) +
  geom_line(alpha = 0.01, aes(group = rep)) +
  facet_wrap(~name, scales = 'free_y', nrow = 3)

trace_boot %>%
  filter(time <= -2000) %>%
  select(rep, type, MAT:twarm) %>%
  pivot_longer(MAT:twarm) %>%
  group_by(rep, name, type) %>%
  tidy_kde() %>%
ggplot(aes(value, estimate)) +
  geom_line(alpha = 0.01, aes(group = interaction(rep, type), color = type)) +
  facet_wrap(~name, scales = 'free_y', nrow = 3)
```

Looking at bootstrapped quantiles (there's a differences between dates and phases, likely because C14 dating is less common in India).

```{r}
trace_boot %>%
  filter(time < -2000) |> 
  pivot_longer(MAT:twarm, values_to = 'temperature') %>%
  mutate(temperature = set_units(temperature, 'degree_c')) %>%
  group_by(rep, name) %>%
  reframe(quant = quantile(temperature, 0.975, type = 8)) %>%
  ggplot(aes(quant)) +
  geom_histogram() +
  facet_wrap(~name, scales = 'free_x')

trace_boot %>%
  filter(time < -2000) |> 
  pivot_longer(MAT:twarm, values_to = 'temperature') %>%
  mutate(temperature = set_units(temperature, 'degree_c')) %>%
  group_by(type, rep, name) %>%
  reframe(quant = quantile(temperature, 0.975, type = 8)) %>%
  ggplot(aes(quant)) +
  geom_histogram() +
  facet_grid(type~name, scales = 'free') +
  theme_bw()
```

group by bin?

```{r}
nsim = 1000
c14_splits_dates <- c14_cleaned %>%
  select(site, C14Age) %>%
  mutate(id = 1:n(),
         cal_grid = cal$grids, .before = geometry) %>%
  slice(which.CalDates(cal, BP > 2000, p = 0.8)) %>% # focus on earlier sites
  bootstraps(times = nsim)

phase_splits_dates <- period_sites %>%
  mutate(id = (1:n()) + nrow(c14_cleaned)) %>%
  filter(age_lower > 2000) %>% # focus on earlier sites
  filter(age_upper < age_lower) %>% # one site has wrong dates?
  select(site, id, age_lower, age_upper) %>%
  bootstraps(times = nsim)

boot_joined_date <- list(c14 = map_dfr(c14_splits_dates$splits, sampler_c14, .id = 'rep'),
                    phase = map_dfr(phase_splits_dates$splits, sampler_phase, .id = 'rep')) %>%
  bind_rows(.id = 'type') %>%
  mutate(time = time * -1)

trace_boot_date <- boot_joined_date %>%
  st_extract(chelsa_trace, ., time_column = 'time', interpolate_time = TRUE) %>%
  st_drop_geometry() %>%
  bind_cols(st_drop_geometry(boot_joined_date) %>% select(-time), .) %>%
  remove_missing() # some dates are earlier than trace

trace_boot_date %>%
  filter(time < -2000)
arch_kde <- trace_boot_date %>%
  filter(time <= -2000) %>%
  select(rep, type, MAT:twarm) %>%
  pivot_longer(MAT:twarm) %>%
  group_by(rep, name, type) %>%
  tidy_kde()

ggplot(test_eks, aes(MAT, estimate)) +
     geom_line(alpha = 0.01, aes(group = rep)) +
  geom_line(data = test_eks2, alpha = 0.01, aes(group = rep), color = 'red')
            
          
ggplot(arch_kde, aes(value, estimate)) +
     geom_line(alpha = 0.01, aes(group = interaction(rep, type), color = type)) +
  facet_wrap(~name, scales = 'free_y', nrow = 3)
```

Plotting spatiotemporal kdes with and without rcarbon functions

```{r}
dens <- arch_trace %>%
  mutate(age = time) %>%
  filter(age < -2000) %>%
  filter(age > -9000) %>%
   mutate(mil = as.factor((age - age %% 1000) / 1000 + 1)) %>%
  arrange(mil) %>%
  group_by(mil) %>%
  st_kde()

ggplot(dens) +
geom_sf(data = st_get_contour(dens))   +
  facet_wrap(~mil)

stkde1 <- stkde(x=cal, coords=st_coordinates(c14_cleaned), win=spatstat.geom::as.owin(asia_bbox_sf), sbw=5, cellres=1, focalyears=seq(9500, 2500, -1000), tbw=500, #bins=rice_bins,
                backsight=500, outdir='data/data-derived/kde_test/', amount=1, verbose=FALSE)

walk(seq(9500, 2500, -1000), ~plot(stkde1, .))
```

## Computational Reproducibility

All analyses carried out in \`R\` \[\@base\]. The entire analysis is run in a reproducible \\\`.qmd\\\` notebook.
