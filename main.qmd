---
title: "Projected warming will exceed the fundamental thermal niche of rice cultivation"
format: 
  nature-pdf: 
    journal: "sn-mathphys-num"
    keep-tex: true
header-includes:
    - \usepackage{setspace}
    - \doublespacing
    - \usepackage{lineno}
    - \linenumbers
author: 
  - name: Nicolas Gauthier
    affiliations:
      - name: University of Florida
        id: 1
        department: Florida Museum of Natural History
    email: nicolas.gauthier@ufl.edu
    attributes:
        corresponding: true
  - name: Ornob Alam
    affiliations:
      - name: New York University
        id: 2
        department: Center for Genomics and Systems Biology
        city: New York
        state: NY
  - name: Michael D. Purugganan
    affiliations:
    - ref: 2
    - name: New York University
      id: 3
      department: Center for the Study of the Ancient World
      city: New York
      state: NY
  - name: "Jade d'Alpoim-Guedes"
    affiliations:
    - name: University of Washington
      department: Department of Anthropology
      city: Seattle
      state: WA
      id: 4
editor: visual
abstract: |
  Rice is a staple food for a significant portion of the global population, particularly in Asia, where over one billion people rely on it as a staple food source. Understanding rice’s fundamental thermal niche is imperative for predicting how it will respond to future shifts in global climate. Here, we integrate diverse records of contemporary rice cultivation extent, archaeological data spanning rice’s long-term history since its earliest cultivation, and temperature projections for the past, present, and future to assess how climate has influenced and may continue to influence rice’s geographical distribution, productivity, and the adaptive strategies employed by human societies to sustain this crucial crop . We show that Asian rice, both wild and domesticated, has rarely grown in regions with a mean annual temperature exceeding 28°C over the past 10,000 years. By 2080, large areas currently under rice cultivation may surpass this critical threshold. Our findings have significant implications for global food security, as regions heavily reliant on rice cultivation may encounter unprecedented challenges in staple crop production under projected warming.
bibliography: references.bib
csl: nature.csl
---

```{r}
#| label: setup
#| include: false
knitr::opts_chunk$set(dev = 'png', echo = FALSE, results = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(sf)
library(stars)
library(ggridges)
library(patchwork)
library(units)
library(rnaturalearth)
library(rnaturalearthdata)
library(here)
library(eks)

theme_set(theme_bw())

# define the study area
asia_bbox_sf <- st_bbox(c(xmin = 60, xmax = 150, ymin = -20, ymax = 50), crs = 4326)
world_bbox_sf <- st_bbox(c(xmin = -130, xmax = 155, ymin = -40, ymax = 60), crs = 4326)

# get country boundaries shapefile for plotting
sf_use_s2(FALSE)
countries <- ne_countries(returnclass = "sf", scale = 'large') %>% 
  st_crop(asia_bbox_sf)
countries_small <- ne_countries(returnclass = "sf", scale = 'small') %>%
  st_crop(asia_bbox_sf)
coasts <- ne_coastline(returnclass = 'sf') %>%
  st_crop(asia_bbox_sf)
coasts_world <- ne_coastline(returnclass = 'sf') %>% 
  st_crop(world_bbox_sf)
countries_world <- ne_countries(returnclass = "sf", scale = 'large') %>% 
  st_crop(world_bbox_sf)
sf_use_s2(TRUE)

country_stats <- readRDS('data/data-derived/country_stats.rds') # country level stats

country_stats %>%
  filter(variable == 'Mean annual temperature') %>%
  select(-percent, -area) %>%
  pivot_wider(names_from = ssp, 
              values_from = sum) %>%
  select(Country = name, Present = present, `SSP1-2.6`:`SSP5-8.5`) %>%
  summarise(across(Present:`SSP5-8.5`, ~sum(.x))) %>%
  mutate(across(everything(), ~.x / Present))

load(here('data/data-derived/occurrence_data.RData'))
erb_decadal <- readRDS('data/data-derived/erb_decadal.rds')
```

# Introduction

Domesticated rice (*Oryza sativa*) serves as a primary food source for over half the global population. More than 90% of the world’s rice is grown in Asia (China, Indonesia, India, Bangladesh, Southeast Asia, Japan, and Pakistan), and one fifth of the world’s population—more than 1 billion people—depends on rice cultivation for their livelihood. *Oryza sativa* has a deep history of cultivation and domestication beginning at least 7,000 years ago. Over the course of its domestication and subsequent spread, Asian rice has made several adaptations to changes in climate and has expanded into new environmental niches well beyond its original range of cultivation. A clear picture of rice’s shifting environmental niche is critical for understanding how rice will respond to future changes in global climate. Given rising global temperatures, the temperature extremes beyond which rice cannot grow are of particular importance. By synthesizing diverse records of the current extent of rice cultivation with archaeological data on the distribution of rice since its earliest cultivation and domestication, this paper aims to establish *O. sativa’s* fundamental thermal limits. Our findings indicate a consistent pattern over the past 10,000 years: both wild and domesticated Asian rice varieties have seldom thrived in regions where the mean annual temperature exceeds 28℃. Alarmingly, climate projections estimate that by 2070-2100 the land area exceeding this thermal threshold in Asia’s major rice-producing nations could expand by ten to thirty times.

Members of the grass family (*Poaceae*), which include staples like rice, maize, wheat, and barley, provide a majority of the global human caloric intake. However, these crops face a looming threat: the rate of anticipated climate change eclipses that of historical niche adaptations in grasses. @cang2016 show that, by 2070, temperatures are projected to rise at a rate 5,000 times faster than what most varieties of *Poaceae* have experienced throughout their evolution. Historically, *Poaceae* experienced temperature shifts ranging from 1-8℃ per million years, yet future projections anticipate changes as swift as 0.02℃ annually [@cang2016].

Rice in particular exhibits a high degree of niche conservatism in comparison to its wild progenitor [@yang2022]. Over recent decades, advancements in rice farming technology have played the pivotal role in the crop’s production. Instead of expanding its niche, rice farming has shifted from previously warmer areas to cooler ones as global temperatures rise [@sloat2020]. Increases in rice’s harvested area over recent decades are deceptive, reflecting advancements in farming technology rather than expansion of its climatic tolerance. For example, rice cultivation in the People’s Republic of China has gradually extended northward from Central China, a shift that, combined with intensified irrigation in the country’s hottest zones, has modestly increased China’s rice yields and masked the adverse effects of rising temperatures on national yields [@sloat2020; @wang2019].

While some areas may benefit from warming temperatures, this trend is not universal. In many regions, smallholder farmers rely on rice cultivation as their main source of income. Indeed, mismatches between rice-harvested areas and overall environmental suitability suggest that subsistence farming in low-income regions has already stretched rice cultivation to its climatic boundaries [@mahaut2022]. To put this into perspective, projections indicate that 15-40% of India's current rainfed rice cultivation zones will experience a reduction in climatic suitability by 2050 [@singh2017]. Since 1974, a staggering 88% of rice-harvested areas show significant shifts in yield due to climatic factors, and these shifts are associated with a 0.4% reduction in the yearly consumable food calories produced from rice [@ray2019].

However, these findings are constrained by the current distributions of rice cultivation and prevailing temperature. Few regions of the world today experience the elevated temperatures projected in many future climate-change scenarios. This makes it challenging to distinguish between inherent thermal limits for rice growth and the practical geographic constraints set by recent temperature distributions. Global temperatures have already exceeded known temperatures over the past 2,000 years and we are living in the warmest centuries of at least the past 100,000 years [@masson-delmotte2021]. Given the accelerating pace of projected future warming, it is paramount to assess the diverse temperature regimes rice has faced throughout its long history of cultivation.

Process-based crop models are one potential set of tools for extrapolating how yields will respond to climate change. Their advantages lie in their ability to simulate yield responses to diverse environmental and social influences. However, the details embedded in these models, which lend them precision for short-term yield forecasts, can result in considerable uncertainty for long-term projections. Factors such as the interactions of meteorological inputs, agronomic and physiological parameters, and assumptions about cultural practices like planting dates and varietal preferences can drastically impact potential future outcomes [@zhang2008; @vanoort2011; @li2015; @koehler2013; @heinicke2022]. Translating projections from localized crop models to the global scale of future climate projections introduces its own set of challenges, as does calibrating and validating their outputs using limited and inconsistent yield data from the recent past. <!--# add citations that future crop projections based on models ultimately come down to these temperature thresholds built in to them, and what we're doing is trying to get at the simpler geographic perspective https://iopscience.iop.org/article/10.1088/1748-9326/ac592e -- understimate heat impaces-->

Instead of focusing on year-to-year yield fluctuations, empirical niche-based suitability assessments emphasize the fundamental feasibility of crop survival. This perspective, focused on the absolute thresholds of plant growth as opposed to localized variations in productivity, offers a parsimonious tool for future crop suitability [@hatfield2011; @Gourdji2012]. It is less swayed by annual variations in yield and harvest area, allowing for the integration of a wider array of data sources. Ultimately, a better understanding of baseline thermal limits and their uncertainty and change through time and space can contribute to the development of future process-based models, many of which incorporate temperature thresholds for pivotal crop development phases.

Previous attempts to define the thermal niche of rice significantly contributed to our ability to understand these constraints in specific regions and production systems, but have often had to prioritize specific spatial or temporal scales. Contemporary studies have provided crucial insights into specific regions, but those with a global scope have often been reliant on particular datasets that may not capture the full diversity of rice occurrences. Notable considerations include the potential underrepresentation of temperate rice varieties in China, the sampling of rainfed or upland varieties, and the geographic scope of the studies, which do not always encompass broad thermal limits [@singh2017; @wang2019]. Similarly, archaeological studies have been instrumental in elucidating the timeline and geographic trajectory of rice’s domestication and spread across Asia [@fuller2009; @long2022; @crema2022; @silva2015; @weber2010], but these analyses are often constrained by the limited accessibility to comprehensive reconstruction data on past climates. Recent integration of archaeological rice records with spatial paleoclimate reconstructions have revealed that climate change played a major role in the early diversification and spread of rice [@dalpoimguedes2018; @gutaker2020], yet the potential implications for rice’s future adaptability have yet to be fully explored. It is thus imperative to contextualize future climate projections within the extensive history of rice’s cultivation and domestication.

Here, we integrate multiple lines of evidence from the extensive history of rice cultivation to establish the fundamental thermal niche of rice and gauge its potential adaptability to impending climate changes. We estimate long-term thermal constraints on rice growth by comparing contemporary estimates of rice extent with well-dated archaeological rice findings, and use the results as a baseline for estimating the impact of projected climate changes in the next 100 years. Our analysis combines present-day rice extent data from diverse sources: satellite-based assessments of paddy rice extent in Asia [@nelson2015], hybrid satellite/census evaluations of global paddy rice cropping areas around the year 2000 [@monfreda2008], and global point occurrences derived from herbarium records and germplasm accessions <!--# figure out correct citation for gbif/genbank data -->. We first estimate the large-scale thermal tolerances for rice cultivation by comparing these records with temperature data on multiple spatial and temporal scales, supplemented by insights prior from field- and lab-based agronomic studies. Then, we synthesize archaeological evidence for rice farming spanning the last 10,000 years in Asia, including direct dates of botanical remains and contextual dating of concurrent archaeological sites. We compare these archaeological rice distributions to modeled and reconstructed climates, assessing the uncertainty in these estimates due to archaeological sampling and dating bias. Finally, we generate simple rule-based models of rice’s thermal niche, supported by machine learning-based ecological niche modeling to estimate the thermal niche of rice<!--# worth keeping? -->, and project future changes in rice extent and genetic maladaptation over the upcoming century under a variety of climate models and scenarios. Together, our analyses confirm that imminent changes in climate conditions may force large regions of today’s primary rice producers to confront mean annual or monthly peak temperatures unprecedented in the history of rice cultivation and domestication.

# Results

## Contemporary rice extents are constrained by high temperatures

We assess thermal constraints on rice growth by comparing contemporary rice extents estimated from satellite imagery, agricultural censuses, and herbarium collections to indicators of annual and seasonal temperature (@fig-overview). We supplement this empirical work with reviews of various field and lab-based agronomic studies.

![Observed rice extent data and thermal predictors. A) Map of lowland rice extent (red) based on estimates from MODIS satellite imagery by @nelson2015. B) Maps of mean annual temperature (top) and mean maximum daily temperature of the warmest month (bottom) from CHELSA V2 averages for the period 1981-2010 [@karger2017; @Karger2018; @brun2022].](figures/1_data.png){#fig-overview}

Contemporary rice extents fall within a relatively restricted thermal range. We focus on mean annual temperature (MAT) and mean maximum daily temperature of the warmest month (TMAX) to estimate upper boundary temperatures for contemporary rice occurrences. We do so for several reasons: crop models will often use fixed monthly/seasonal predictors and predictors relative to timing of growing season. These predictors depend on planting dates, which are themselves cultural adaptations to past and current climate. Cultural/agricultural decision making in planting times and the length of the growing season can shift, opening a new avenue for adaptation and confounding statistical analyses. By focusing on large-scale climate measures, we seek to reveal the fundamental upper threshold to which rice has adapted.

```{r}
#| label: quantiles-modern

fig2_dat <- irri_occ %>%
  st_drop_geometry() %>%
  filter(presence == 1) %>%
  select(bio1, bio5, bio10) %>%
  mutate(across(everything(), ~units::set_units(.x, 'degree_C')))

quantiles <- c(0.025, 0.05, 0.1, 0.9, 0.95, 0.975)

quants_mod <- fig2_dat %>%
  reframe(across(everything(), 
                   ~quantile(.x, quantiles, type = 8))) %>%
  round(1) %>%
  mutate(quantile = quantiles, .before = 1)

quant_975 <- filter(quants_mod, quantile == 0.975)
bio1_limit <- quant_975$bio1
bio5_limit <- quant_975$bio5
bio10_limit <- quant_975$bio10
```

Our results reveal that the vast majority of contemporary rice is grown in regions with MAT below `r bio1_limit`℃ and TMAX of `r bio5_limit`℃ (@fig-kde-modern, Supplementary @tbl-quantiles). These empirical thresholds are consistent with physiological parameters inferred from field-scale agronomic studies and expert knowledge, which estimate that the optimum temperature range for reproductive yield in rice is 23℃-26℃ and that crop viability reaches zero at approximately 40℃ when photosynthesis begins to shut down in C3 plants like rice [@hatfield2011]. As annual and monthly temperatures may not adequately reflect the climate experienced by crops during the growing season, we also compared rice extents to seasonal temperature measures. The majority of rice crops are grown in regions with maximum temperatures of the warmest quarter less than `r bio10_limit`℃. Although this seasonal climate variable is strongly correlated with MAT and TMAX at regional to global scales, this threshold also has physiological significance. Rice biomass and pollen viability declines when maximum temperatures exceed 33℃ [@hatfield2011]. In other words, rice today is not grown in regions where the mean annual temperature is warmer than its optimum temperature for grain yield, where warm-season maximum temperatures exceed its optimum temperature for reproduction, and where summer temperature extremes will reliably stop photosynthesis.

```{r}
#| label: fig-kde-modern
#| fig.height: 7
#| fig.width: 6
#| fig.cap: "Kernel density estimates of temperature distributions over rice growing landscapes. A) One-dimensional kernel density estimates of mean annual temperature and mean maximum daily temperature of the warmest month in grid cells with lowland rice crops, based on the data from Figure 1. Vertical black lines indicate the 95% central range of the temperature values, and transparent black points indicate the raw occurrence data used in the calculation of the kernel density estimates. B) Two dimensional kernel density estimates for the same variables as in A."

a <- fig2_dat %>%
  pivot_longer(bio1:bio10, names_to = 'var') %>%
  mutate(name = factor(case_when(var == 'bio1' ~ 'Mean annual',
                                 var == 'bio5' ~  'Max month',
                                 var == 'bio10' ~  'Max quarter'),
                        levels = c('Mean annual', 
                                   'Max quarter',
                                   'Max month'))) %>%
  ggplot(aes(value, name)) +
  scale_y_discrete(limits = rev) +
  geom_density_ridges(alpha = 0.75, scale = 1, jittered_points = TRUE, position = 'raincloud', point_alpha = 0.25, point_size = 0.5, quantile_lines = TRUE, quantiles = c(0.025, 0.975))+
  labs(x = 'Temperature', y = '') +
     theme(axis.text.y = element_text(vjust = 0)) +
coord_cartesian(clip = 'off')

b <- fig2_dat %>%
  ggplot(aes(bio1, bio5)) +
  stat_density_2d(geom = 'polygon', aes(alpha = after_stat(level))) +
  labs(x = 'Mean annual temperature', y = 'Max temp. of warmest month') +
  scale_alpha_continuous(guide = 'none') +
  coord_fixed() +
  scale_x_units(limits = set_units(c(2, 30), degree_C))

a / b + plot_layout(heights = c(1.5, 2)) + plot_annotation(tag_levels = 'A', tag_suffix = ')')
```

Although we primarily report results from the satellite-based estimates of lowland rice extent over Asia produced by the International Rice Research Institute [@nelson2015] due to its favorable balance of spatial resolution and extent, results from other rice extent datasets with variable spatial extent, resolution, and time span are largely consistent with these findings. There is much more variability across data sources in lower temperature thresholds than upper temperature thresholds, reflecting the greater adaptability of rice to colder temperatures through breeding, management, and growing season.

Although optimum growing temperatures vary between rice varieties, there is greater stability in their maximum temperature tolerance. *Oryza sativa japonica* has two key separate varieties: photosensitive tropical varieties and non photosensitive temperate varieties which have been adapted to the northern hemisphere. Temperate and tropical varieties are clearly distinguished in the bimodal distribution of occurrences, with temperate varieties occurring between 10°C and 20℃ MAT and tropical varieties between 22℃ and 29℃.

The same pattern holds when looking at average temperatures of the coldest and warmest quarters, with a clear separation between the two varieties at 12℃ cold temperatures and a max of 30℃, and an upper temperature threshold of about 33℃ warm season temperatures. Notably, the range of minimum temperatures spanned by rice is much larger than the span of maximum temperatures, as well as the differentiation between the two varieties. Likewise, the maximum temperatures for both seasonal variables are similar, in the 30-35℃ range. This suggests that the primary genetic adaptations that rice has made to temperature have been adaptations to cooler rather than warmer conditions [@gutaker2020].

## High-temperature constraints are consistent across 8,000 years of rice cultivation

Although upper temperature limits on rice growth estimated from contemporary crop extents are consistent with previous agronomic studies, it is not yet clear how well these thresholds will predict crop responses to future temperature changes. Beyond the Sahara and Gulf deserts, there are few places today that experience mean annual temperatures beyond 28℃, and contemporary correlations between mean annual temperatures and monthly or seasonal extremes may not hold in a changing climate.

To assess the long-term robustness of these upper temperature limits, we collected archaeological indicators of rice cultivation from the past several thousand years and compared their distribution to climate model estimates of past temperature change. During the mid Holocene (ca 8000-4000 cal. BP), mean annual and growing season temperatures were generally warmer than present, reflecting increased summertime insolation in the Northern Hemisphere due to shifts in Earth’s orbit and consequent feedbacks in the global climate system [@berger1991]. Although not an exact analogue for projected future warming due to greenhouse gas emissions, this period provides a baseline for rice’s response to shifting climates during the critical period of its domestication and dispersal.

*O. sativa* has been domesticated a number of times in prehistory. Archaeological data shows that wild forms of rice were distributed as far as northern China in the early Holocene (ca 9000 cal. BP) and gathered by foraging populations [@fuller2011]. Tropical varieties of *O. sativa japonica* were first cultivated in the middle and lower Yangtze and Yellow River valleys in China by at least 7000 cal. BP [@huang2012; @choi2017; @choi2018] (@fig-arch-kde A), where they began to exhibit traits of domestication (e.g. the development of a non-shattering rachis) by roughly 5000 cal. BP [@fuller2009; @Silva2015]. *Oryza sativa indica* rices on the other hand were likely domesticated in South Asia sometime around 4000 cal. BP [@fuller2016; @bates2022], following this it spread throughout southeast Asia and China (@fig-arch-kde A). There is substantially less archaeobotanical data, however, that speaks to the cultivation and subsequent domestication of this cultivar [@bates2022]. This period of initial cultivation and domestication corresponds to the warmer mid-Holocene thermal maximum.

Between roughly 5000-4000 BP, rice spread both north- and eastward in China [@lanehart2011; @dalpoimguedes2015] and westward onto the Chengdu Plain [@dalpoimguedes2013] and highlands of Southwest China [@dalpoimguedes2014; @dalmartello2018] (@fig-arch-kde A). Genetic and paleoclimate modeling have suggested that regional cooling around 4200 BP played an important role in this spread resulting in strong pressure for tropical *O. japonica* to develop temperate adaptations [@gutaker2020]. Estimated divergence time for tropical and temperate *O. japonica* is indeed estimated at around 4100 BP [@gutaker2020]. Following the development of temperate *O. japonica* varieties, rice spread to both Korea [@crawford2003; @ahn2010] and Japan [@crema2022] (@fig-arch-kde A). At the same time, it appears that the niche that tropical varieties of *O. japonica* were able to occupy shifted southwards to southern China [@yang2017; @deng2022] and southeast Asia [@castillo2018; @higham2015; @dalpoimguedes2020] (@fig-arch-kde A). Indeed between 4000-3000 BP, we see that rice farming spreads into Thailand [@dalpoimguedes2020], Laos, Bhutan and then spreads through maritime routes to Taiwan, the Philippines, Malaysia and Indonesia [@gutaker2020] (@fig-arch-kde A). A clear split in the distribution of rice with regards to temperature is evident following 4000 BP and we see a clear split into two populations: temperate varieties which occupy a mean annual temperature niche between roughly 8-18℃ and tropical varieties which occupy a niche between 22-27℃ (@fig-arch-kde B).

```{r}
#| label: fig-arch-kde
#| fig-width: 9
#| fig-height: 8
#| cache: true
#| fig-cap: Archaeological remains of rice and corresponding temperature distributions throughout the Holocene. A.) Archaeological records of rice distribution over time. See Methods for archaeological data sources. Time units are thousands of years before present (1950 CE). B.) Kernel density estimates of the thermal niche by millennium, with raw data points indicated in black and contemporary rice thermal limits in red. Rice occurrence data were derived from sources listed in the Methods section. Temperature data are derived from CHELSA-TRACE V1.2 (Karger et al. 2022). 

arch_trace_dat <- readRDS(here('data/data-derived/arch_trace.rds')) |>
  mutate(mil = (med_age - med_age %% 1000) / 1000 + 1) |>
  filter(between(mil, -9, -2)) |>
  mutate(mil = as.factor(mil))

arch_map <- arch_trace_dat %>%
  ggplot() +
  geom_sf(data = countries, color = 'white') +
  geom_sf(size = 1, alpha = 0.75) + 
  facet_wrap(~mil, ncol = 4)

arch_dens_mat <- arch_trace_dat %>%
  ggplot(aes(MAT, mil)) +
  scale_y_discrete(limits = rev) +
  geom_density_ridges(aes(fill = mil), 
                      panel_scaling = TRUE, 
                      scale = 2, 
                      alpha = 0.5, 
                      jittered_points = TRUE, 
                      point_alpha = 0.25, 
                      point_size = 0.5) +
  labs(y = 'Millennium BP', x = 'Mean annual temperature') +
  geom_vline(xintercept = as.numeric(bio1_limit), linetype = 2, color = 'red') +
  scale_fill_brewer(palette = 'Spectral', guide = 'none')

arch_dens_tmax <- arch_trace_dat %>%
  ggplot(aes(tmax, mil)) +
  scale_y_discrete(limits = rev) +
  geom_density_ridges(aes(fill = mil), 
                      panel_scaling = TRUE, 
                      scale = 2, 
                      alpha = 0.5, 
                      jittered_points = TRUE, 
                      point_alpha = 0.25, 
                      point_size = 0.5) +
  labs(y = 'Millennium BP', x = 'Max temp. of the warmest month') +
  geom_vline(xintercept = as.numeric(bio5_limit), linetype = 2, color = 'red') +
  scale_fill_brewer(palette = 'Spectral', guide = 'none')

arch_dens_twarm <- arch_trace_dat %>%
  ggplot(aes(twarm, mil)) +
  scale_y_discrete(limits = rev) +
  geom_density_ridges(aes(fill = mil), 
                      panel_scaling = TRUE, 
                      scale = 2, 
                      alpha = 0.5, 
                      jittered_points = TRUE, 
                      point_alpha = 0.25, 
                      point_size = 0.5) +
  labs(y = 'Millennium BP', x = 'Max temp. of the warmest quarter') +
  geom_vline(xintercept = as.numeric(bio10_limit), linetype = 2, color = 'red') +
  scale_fill_brewer(palette = 'Spectral', guide = 'none')

arch_map / 
  (arch_dens_mat + arch_dens_tmax + arch_dens_twarm + plot_layout(guides = 'collect')) +
  plot_annotation(tag_levels = 'A') + 
  plot_layout(heights = c(2, 1))
```

These repeated instances of rice’s diversification and shifting ranges throughout its history primarily reflect genetic and cultural adaptations to cooler temperatures and shorter growing seasons. However, its upper temperature limits have remained a relatively constant barrier to dispersal. No rice remains are recovered from regions experiencing greater than 28℃ MAT (@fig-arch-kde B), in spite of warmer conditions overall. These results are robust to uncertainty in both the dating of these archaeological remains as well as spatial biases in archaeological site preservation and recovery (Supplementary Figure @fig-bootstrap). Out of our dataset of 618 sites, only seven, located in the Thar desert in Pakistan (a highly arid environment not adapted to rice cultivation), have rice in areas that experienced a TMAX of greater than 40.5℃ (@fig-arch-kde C). These extreme outliers appear to be the result of dating uncertainty (Supplementary Figure @fig-bootstrap b), as well as long-distance trade in rice rather than local cultivation. Regardless, this period of higher temperatures was a relatively extreme century, during which historical and archaeological evidence attest to significant cultural disruption in the impacted regions (Supplementary Figure @fig-erb-recon).

## Currently cultivated rice areas are projected to exceed these thermal limits over the next century

Although rice has spread to warmer environments since its domestication, the magnitude of this change over the past 8,000 years is small relative to anticipated changes in the next 100 years. Multiple climate-model projections and future socioeconomic and emissions scenarios show large shifts in mean annual temperatures in regions where rice is currently cultivated intensively, particularly in South, Southeast and Island Southeast Asia (@fig-future-densities). <!--# more detailed description of model spread (ie ukesm model in china)? --> Mean annual temperature will exceed `r round(bio1_limit)`℃ for a substantial area of current occurrences in the years 2070-2100. Large parts of South, Southeast, and Island SE Asia will experience temperature conditions for which there is no analogue in the history of the cultivation and domestication of rice over at least the past 8,000 years (@fig-future-maps). Although the extent of these projected shifts vary among climate models and emissions scenarios, the overall direction of this change is consistent (Supplementary @fig-niche-all-models-bio1, @fig-niche-all-models-bio10, @fig-niche-all-models-bio5).

Likewise, a genetic offset analysis assessing the potential maladaptation of *O. sativa* subspecies to future climate scenarios, correlating contemporary genetic variation with annual and seasonal temperature, indicates both subspecies are at a significantly higher risk of maladaptation under projected temperature regimes of the coming century (@fig-offsets). When projecting to future climates across Asia, optimal growing locations for rice landraces of both subspecies show a greater skew away from the equator in the likeliest emissions scenarios. <!--# (Supplementary @).link? -->

```{r}
#| label: cmip6-data
model_names <- c('gfdl', 'ipsl', 'mpi', 'mri', 'ukesm')
ssp_names <- c('ssp126', 'ssp370', 'ssp585')

cmip6 <-  model_names %>%
  map(paste,  ssp_names, sep = '/' ) %>%
  map_depth(1, ~paste0('~/Dropbox (UFL)/Data/CHELSA/CMIP6/2071-2100/', .x, '/bio') %>% as.list()) %>%
  map_depth(2, ~list.files(.x, full.names = TRUE, pattern = '*_bio1_|_bio5_|_bio10_*')) %>%
  map_depth(2, ~read_stars(.x) %>%
              setNames(c('bio1', 'bio10', 'bio5')) %>%
              st_redimension()) %>%
  map(~do.call('c', .x) %>% 
        setNames(c('SSP1-2.6', 'SSP3-7.0', 'SSP5-8.5')) %>% 
        st_redimension()) %>%
  do.call('c', .) %>%
  setNames(model_names) %>%
  st_redimension() %>%
  st_set_dimensions(names = c('x', 'y', 'variable', 'ssp', 'model')) %>%
  setNames('temperature') %>%
  .[countries]
```

```{r}
#| label: fig-future-densities
#| fig-cap: "Predicted changes in biologically relevant temperature indicators over currently cultivated rice areas in Asia, relative to contemporary thermal thresholds (red line). Shared socioeconomic pathways (SSPs) are scenarios of projected socioeconomic global changes used to derive greenhouse gas emission scenarios. SSP1 is a best case scenario where strong global cooperation focused on sustainability and social and technological innovation are able to reduce greenhouse gas emissions. SSP3 is a middle-range scenario characterized by high population growth and global competition that hinders social and technological innovation. SSP5 is a worst case scenario characterized by rapid economic growth and carbon emissions. All temperature estimates are derived from CMIP6 climate model ensemble mean estimates for the years 2071-2100, selected based on the ISIMIP3b protocol and downscaled by the CHELSA-V2.1 algorithm."

fig5_quantile_data <- quants_mod %>%
               filter(quantile == 0.975) %>%
               pivot_longer(-quantile,
                            names_to = 'variable',
                            values_to = 'temperature') %>%
   mutate(variable = factor(
           case_when(variable == 'bio1' ~ 'Mean annual temperature',
                     variable == 'bio5' ~  'Max temperature of the warmest month',
                     variable == 'bio10' ~ 'Max temperature of warmest quarter'),
           levels = c('Mean annual temperature', 
                      'Max temperature of the warmest month', 
                      'Max temperature of warmest quarter')))

irri_occ %>%
  filter(presence == 1) %>%
  st_extract(cmip6, .) %>%
  as_tibble() %>%
  st_drop_geometry() %>%
  group_by(geometry, variable, ssp) %>%
  summarize(temperature = mean(temperature)) %>%
  ungroup() %>%
  mutate(temperature = units::set_units(temperature, degree_c)) %>%
  bind_rows(pivot_longer(fig2_dat, everything(), 
                         names_to = 'variable', values_to = 'temperature') %>%
              mutate(ssp = 'present')) %>%
  mutate(ssp = factor(ssp, 
                      levels = c('SSP5-8.5', 'SSP3-7.0', 'SSP1-2.6', 'present')),
         variable = factor(
           case_when(variable == 'bio1' ~ 'Mean annual temperature',
                     variable == 'bio10' ~ 'Max temperature of warmest quarter',
                     variable == 'bio5' ~  'Max temperature of the warmest month'),
           levels = c('Mean annual temperature', 
                      'Max temperature of warmest quarter',
                      'Max temperature of the warmest month'))) %>%
  ggplot(aes(temperature)) +
  geom_density(aes(fill = ssp), alpha = 0.5) +
  scale_fill_brewer(palette = 'Spectral', direction = 1, name = '') +
  facet_wrap(~variable, ncol = 1, scales = 'free_y') +
  geom_vline(data = fig5_quantile_data, 
             aes(xintercept = temperature), linetype = 2, color = 'red') +
  labs(x = 'Temperature')
```

```{r}
#| label: fig-future-maps
#| fig-cap: "Land areas projected to exceed each temperature threshold by 2071-2100 from CMIP6 simulations, based on the ISIMIP3b protocol and downscaled by CHELSA-V2.1. Color intensity corresponds to the count of climate model ensemble members surpassing the given threshold at each grid cell."
#| cache: true
#| fig-width: 11.5
#| fig-height: 8

fig5_map_data <- cmip6 %>%
  split('variable') %>%
  mutate(bio1 = bio1 > units::drop_units(bio1_limit),
         bio10 = bio10 > units::drop_units(bio10_limit),
         bio5 = bio5 > units::drop_units(bio5_limit)) %>%
  rename(`Mean annual temperature` = bio1,
         `Max temperature of warmest quarter` = bio10,
         `Max temperature of warmest month` = bio5) %>%
  merge(name = 'variable') %>%
  st_apply(c('x', 'y', 'ssp', 'variable'), sum) %>%
  mutate(sum = factor(sum)) 

ggplot() +
  geom_stars(data = fig5_map_data, downsample = 10) +
  facet_grid(ssp~variable) +
  scale_fill_brewer(palette = 'OrRd', direction = 1, 
                    name = 'Models', 
                    na.value = NA, na.translate = FALSE) +
  geom_sf(data = coasts) +
  labs(x = '', y = '')
```

```{r}
#| label: fig-offsets
#| fig-width: 12
#| fig-height: 8
#| cache: true
#| fig-cap: "Estimated genetic offsets of sampled rice landraces for past and future scenarios relative to current baseline. Each point represents a distinct population sampled for genetic analysis. Higher genetic offsets indicate a greater degree of maladaptation to the potential temperature regime. The past scenario reflects the highest modeled temperature at each location across the entire span of rice's cultivation. The future scenarios are averaged across SSP."

offset_2.6 = readRDS("data/data-derived/for_plotting/offset_2.6_PC1_K8.rds")
offset_7.0 = readRDS("data/data-derived/for_plotting/offset_7.0_PC1_K8.rds")
offset_8.5 = readRDS("data/data-derived/for_plotting/offset_8.5_PC1_K8.rds")
offset_past = readRDS("data/data-derived/for_plotting/offset_past_PC1_K8.rds")
ind_offset_2.6 = readRDS("data/data-derived/for_plotting/ind_offset_2.6.rds")
ind_offset_7.0 = readRDS("data/data-derived/for_plotting/ind_offset_7.0.rds")
ind_offset_8.5 = readRDS("data/data-derived/for_plotting/ind_offset_8.5.rds")
ind_offset_past = readRDS("data/data-derived/for_plotting/ind_offset_past.rds")

inds_geotagged = readRDS("data/data-derived/for_plotting/indica_geotagged.rds")
japs_geotagged = readRDS("data/data-derived/for_plotting/japonica_geotagged.rds")


# this is the order of the japonica accessions in the genotype matrix
japs = read.table("data/data-derived/for_plotting/japs_order.txt")
inds = read.table("data/data-derived/for_plotting/inds_order.txt")

indica_dat = tibble(inds$V1,
                  ind_offset_2.6$offset,ind_offset_2.6$distance,
                  ind_offset_7.0$offset,ind_offset_7.0$distance,
                  ind_offset_8.5$offset,ind_offset_8.5$distance,
                  ind_offset_past$offset,ind_offset_past$distance) %>%
  setNames(c("ID","offset_2.6","rona_2.6",
                   "offset_7.0","rona_7.0",
                   "offset_8.5","rona_8.5",
                   "offset_past","rona_past"
                   )) %>%
    left_join(inds_geotagged) %>%
  select(-starts_with('rona')) %>%
  pivot_longer(starts_with('offset')) %>%
  arrange(value) %>%
  rename(scenario = name)


japonica_dat <- tibble(japs$V1,
                  offset_2.6$offset,offset_2.6$distance,
                  offset_7.0$offset,offset_7.0$distance,
                  offset_8.5$offset,offset_8.5$distance,
                  offset_past$offset,offset_past$distance) %>%
  setNames(c("ID",
                   "offset_2.6","rona_2.6",
                   "offset_7.0","rona_7.0",
                   "offset_8.5","rona_8.5",
                   "offset_past","rona_past"
                   )) %>%
  left_join(japs_geotagged) %>%
  select(-starts_with('rona')) %>%
  pivot_longer(starts_with('offset')) %>%
  arrange(value) %>%
  rename(scenario = name)

offset_dat <- list(indica = indica_dat,
     japonica = japonica_dat) %>%
  bind_rows(.id = 'var')

ggplot(offset_dat) +
  geom_sf(data = countries, color = 'white') +
  geom_point(aes(LON, LAT, color = value)) +
  scale_color_viridis_c(option = 'magma', name = 'Offset') +
  facet_grid(var~scenario) + 
  labs(x = '', y = '')
```

# Discussion

There is a clear maximum limit of mean annual temperatures over `r round(bio1_limit)`℃ for rice that has not been crossed both over the history of this cultivar's domestication or for the current distribution of its wild progenitor. Forward looking climate projections show that areas that currently house some of the highest densities of rice cultivation on Earth will surpass this limit by 2070 (@fig-future-maps). Today, 675 million people live in Southeast Asia and 1.9 billion people live in South Asia. By 2080 it is estimated that at least this number of people will live in the region that will be above `r round(bio1_limit)`℃. Today, mean annual temperatures greater than `r round(bio1_limit)`℃ are distributed across only a very small area of the planet which includes only a small portion of the gulf desert and the Sahara [@Xu2020]. Beyond the impact of this heat on rice cultivation, this study raises serious concerns about the viability of plant life in regions which will be impacted. The predictions for these areas of the world are out of the historic sample of distribution for rice and have no analogue in the present climate.

Shifting rice production north to regions currently too cold to grow rice will be insufficient to buffer these projected impacts. Beyond the potential for unanticipated social and environmental impacts [@hannah2020], this response does nothing for the billions of people who live in these hotter regions whose lives and livelihoods are directly threatened. This response would also ignore that rice cultivation requires extensive niche construction through the construction of paddies and that abiotic factors such as sufficient water for irrigation and soils which can accommodate paddy rice. Indeed many areas where rice is currently cultivated are already at the limit of these secondary agronomic adaptations [@mahaut2022]. Ethnographic work has shown that in Southeast Asia and China rice paddy soils have been formed over thousands of years of continuous farming which has increased their fertility [@netting1993]. These long-term processes of niche construction like this cannot be easily replaced.

Shifts in planting dates to winter may provide solutions in some regions, however, the higher temperatures are still a concern, as rice is also sensitive to warmer nighttime temperatures in the early growing period [@peng2004]. Likewise, as above, large scale socio-cultural adaptations, while possible, imply significant downstream impacts on regional cultures and economies that can be difficult to anticipate and mitigate ahead of time. In addition, it is likely that tropical varieties of *O. japonica* will need to shift northwards to higher latitudes, yet these varieties are highly sensitive to day length and the development of non-photosensitive temperate *O. japonica* may have taken thousands of years. A major breeding objective for the coming decades will thus be to develop non-photosensitive varieties of tropical rice, as well as matching cultivation strategies [@wang2022].

In this vein, the stored germplasm of landraces may serve as important genetic resources to breed climate-adaptive loci into high-yielding commercial rice varieties [@nomura2021; @vasconcelos2013; @mcnally2023]. Compared to modern cultivars, landraces contain higher genetic diversity [@hour2020; @thomson2007] and adaptations to a wider range of climates [@vasconcelos2013]. Maladaptation of rice landraces under future climates may thus be amplified in modern cultivars. Although there is some degree of noise in the estimation of genomic offset statistics, they remain powerful predictors of maladaptation in projected climates [@gain2023]. A warming climate also threatens wild relatives of rice and the genetic resources they contain, which are currently largely limited to South and Southeast Asia and cannot disperse as quickly without human intervention [@cang2016].

Our focus here on annual and seasonal temperature indicators allows for the integration of a broader array of data and provides a more flexible analysis less sensitive to uncertainty in cultivar type, growing season, and local management practices. However, future work could explore this variability further by developing new temperature indicators that are more sensitive to the unique requirements of various cultivars, growing seasons, and agro-ecological contexts. Temperature is not the only climate variable that influences rice growth. Others like soil moisture and solar radiation are also critical to rice growth in ways that, likewise, depend on cultivar type, growing season, and management practices. Extending this analysis to the global and regional climatic drivers of local climate response of these multiple variables, such as the influence of sea surface temperature variability and atmosphere-ocean teleconnections, could provide opportunities to incorporate long-term climate reconstructions and projections of climate impacts on rice viability. A more precise estimation of the long-range correlations between key climate variables in space and time, based on long-term insights from the archaeological and paleoclimatological record, would be particularly useful for developing holistic recommendations for future agronomic and genetic adaptations.

Our interdisciplinary approach highlights a pressing reality: the vast historical perspective of rice cultivation combined with past and present climate data provide a sobering outlook for food security during future climatic shifts. Staple food resources entrenched in centuries or millennia of cultural and socio-economic development face unprecedented challenges in the coming decades. The implications of these challenges extend beyond agriculture and resonate through trade dynamics, economic systems, and deep-rooted cultural practices. The potential displacement of rice cultivation zones suggests not merely a change in global food patterns but a profound disruption of human societies rooted in these agronomic traditions. Before us lies an urgent necessity for international research, collaboration, and adaptive policy-making to strengthen the resilience of this crop that sustains billions.

# Methods

## Climate Data

We used high-resolution gridded climate data from version 2 of the CHELSA product [@karger2017, @Karger2018, @brun2022, @brun]. CHELSA incorporates bias-corrected outputs from the ERA-5 reanalysis with high-resolution terrain data using mechanistic relationships between local climate and terrain. Compared to other global gridded climate products, CHELSA offers superior performance in mountainous regions. Its reliance on high-quality reanalysis data instead of raw weather station data ensures greater accuracy and internal consistency among climate variables.

For present-day observed climate, we used the CHELSA V2.1 product spanning the period 1980-2010 at a 1km resolution. We further aggregated the native 1km data to 5km and 10km grids to assess the sensitivity of our results to the scale of the analysis, given the variable spatial support of the contemporary rice extent data. In all cases we used the standard 19 Bioclim variables used in ecological niche modeling studies [@brun], derived from monthly climatologies of precipitation and minimum and maximum temperature, which collectively represent annual means, extremes, and seasonality across the annual cycle.

Past data were derived from the CHELSA-TRACE product, a downscaled version of TRACE-21k simulation using the CCSM3 climate model spanning the last 21,000 years at 100 year intervals [@karger2021, @He2011]. This product uses the older CHELSA V1.2 algorithm, along with a trend-preserving bias correction and topographic correction for shifting ice sheets across the deglacial period. Future climate model ensembles were derived from phase six of the Coupled Model Intercomparison Project (CMIP6) [@eyring2016], using the subset of bias-corrected models and scenarios used in phase 3b of the Inter-Sectoral Impact Model Intercomparison Project (ISIMIP) [@lange2019], bilinearly interpolated to the CHELSA V2.1 basemap using the delta change approach [@brun, @brun2022].

## Contemporary Rice Distribution Data

We collected rice occurrence data from a variety of sources combining information from satellites, administrative statistics, and herbarium collections. Our goal was to assess the sensitivity of our results to various modes of data collection, sampling, spatiotemporal scale, and other potential sources of error.

-   Satellite-based estimates of lowland rice extent in Asia [@nelson2015]. This dataset employs high-resolution (500m) presence-absence markers from MODIS observations and offers relatively uniform sampling across both temperate and tropical regions. It provides a more objective approach than spatially biased occurrence records. However, its coverage is limited to East and Southeast Asia and it may poorly distinguish intercropped wheat and rice in Northeast China and natural wetlands and paddy rice cultivation in Indonesia. To minimize such sampling issues, we aggregated the 500m data into 5km grid cells, dropping occurrences with less than 10% coverage to minimize false positives from low-pixel observations. Subsequent analyses of these data proved robust to the exact resolution and coverage threshold used.

-   Estimates of paddy rice harvested areas around the year 2000 [@monfreda2008]. This dataset, integrates satellite-based estimates of cropland with sub-national statistics for rice harvested areas. It utilizes geospatial cropland maps to break down harvest area and yield census data and offers global coverage at approximately 10km resolution. Countries that lack detailed administrative data at the subnational level, such as Laos and Kazakhstan, can exhibit overly smoothed areas. The use of harvested area as a metric can be misleading in regions with multiple annual harvests, leading to double or triple counting.

-   A geolocated, point-based occurrence records for rice and its wild progenitor synthesized from previous studies [@civán2018; @yang2022; @ramirez-villegas2022], originally sourced from GBIF, the Rice Haplotype Map project, and other datasets based on herbarium specimens or germplasm samples from international genebank databases. Given their direct identification, these occurrence records generally offer greater reliability than area-averaged crop occurrences derived from satellites and sub-national statistics. Nonetheless, they are susceptible to spatial sampling bias. For instance, regions like China are underrepresented in GBIF in terms of sampling effort compared to neighboring countries with similar geographical extent, and herbarium collections may more accurately sample upland rice varieties at the expense of larger paddy fields. After creating the full combined datasets, geolocations were checked for anomalous entries then thinned to a uniform grid to minimize irregular spatial sampling.

We sampled the contemporary CHELSA climate data at each set of occurrence points for each data type to calculate temperature distributions and quantiles. We explored various combinations of grid/point resolution for the climate and occurrence datasets from 1-10km, but found this did not impact the upper temperature threshold estimates.

<!--# For subsequent machine learning analyses, which depend on both presence and absence points, we randomly sampled temperature values at an equivalent number of latitude-weighted background points values from points within 100km of the presence points, to ensure representative sampling of reasonable temperature ranges. -->

## Archaeological Data

We anchored our analysis on rice occurrence data sourced from archaeological sites, as delineated in @Guedes2018 and @long2022. Both studies extend the primary data collected in version 2 of the Rice Archaeological Database [@silva2015]. Notably, their data predominantly covers East Asia, but to augment our scope---particularly in Japan---we also integrated data points from @crema2022.

The records are typically of botanical remains, believed to represent *O. sativa japonica* from these archaeological sites, with less intensive sampling of *indica* varieties from northern India. However, based on their chronology, some occurrences might pertain to the wild-type *O. rufipogon* or *O. nivara*.

After data harmonization---which involved eliminating potential outliers, rectifying misclassifications, and removing duplicated site data---we were left with a comprehensive dataset of 1,373 dates from 618 archaeological sites. These datasets comprise a mixture of direct radiocarbon dates on rice remains, alongside dates from associated contextual materials and ranges anchored in prevailing archaeological eras. We employed the Intcal20 calibration curve for recalibrating all radiocarbon dates, barring a single site in the southern hemisphere where we utilized SHcal20. To navigate the chronology uncertainties, we generated 5,000 bootstrap replicates, stemming from the radiocarbon dates’ posterior density distribution and a uniform density for the phase dates. Subsequent extraction of temperature variables from the CHELSA-TraCE dataset was done at the sample locations, and we interpolated bilinearly across time as needed. Lastly, we constructed unique kernel density estimates of the temperature distributions at each rice occurrence point for every bootstrap replicate and temperature variable.

## Genetic Data

We performed a genetic offset analysis to evaluate the potential maladaptation of *Oryza sativa* subspecies *indica* and *japonica* under projected climate change scenarios. The workflow entailed a gene-environment association analysis focusing on the first principal component (PC1) of the three temperature variables, which explained over 81% of the environmental variance across the locations of both rice subspecies. This analysis corrected for population structure and identified outlier single nucleotide polymorphisms (SNPs) as candidate loci from each linkage group. We leveraged a large dataset of geotagged *japonica* and indica accessions and biallelic SNPs filtered for quality and imputed for missing genotypes. The genetic offset, indicative of maladaptation to predicted climates, was calculated using these loci. We averaged model predictions across each climate models (UKESM, MRI, IPSL, etc.) in the ensemble for each Shared Socioeconomic Pathway (SSP).

Landraces are representative of the extant genetic diversity of crop species, and frequently exhibit local adaptations from sustained cultivation in specific geographic localities. Sampling landraces of a crop over a wide geographical area and sequencing their genomes can help identify putative adaptive variants associated with different environments. Genetic offset statistics provide measures of maladaptation under different or projected climate scenarios, based on association of genotypes with environmental variation [@gain2023].

Using previously published datasets of geo-tagged rice landraces belonging to the subspecies *O. sativa ssp. Indica* [@gutaker2020] and *O. sativa ssp. Japonica [@alam2021]*, we performed gene-environment association (GEA) analyses with lfmm2 function from the R package LEA (v3.12.2) — on the two subspecies separately — to identify variants associated with variation in temperature [@gain2021]. Temperature was represented by the first principal component (PC1) of mean annual temperature (bio1), mean maximum daily temperature of the warmest month (bio5), and mean daily temperature of the warmest quarter (bio10) from CHELSA V2 averages for the period 1981-2010. PC1 represented 84.6% and 86.12% of the variation in the environmental data for the *indica* and *japonica* datasets, respectively. To correct for population structure in the GEA, we provided the number of ancestral populations, K, as the number of latent factors in our latent factor mixed models [@gain2021]. We selected the number of ancestral populations based on the number of principal components of the genotype matrix that explain a large proportion of the variance, the cross-entropy — a measure of model fit — of different values of K, and information from prior studies [@gutaker2020; @alam2021]. Variants identified in the GEA were clumped within 100 kb of each other, selecting the variant with the lowest p-value as the focal SNP.

We used the genetic.offset function of the R package LEA [@gain2021] to calculate genomic offset statistics for rice landraces of *O. sativa ssp. Indica* and *O. sativa ssp. Japonica* while considering the temperature-associated variants as putative adaptive variants under the SSP1, SSP3, and SSP5 projected pathways that are used to derive greenhouse gas emission scenarios. We also calculated genomic offset statistics under the maximum estimated temperature at each location in the past 12,000 years. For both *japonica* and *indica*, the degree of maladaptation increases from SSP1, which is a best-case scenario with decreasing greenhouse gas emissions, to SSP3 to SSP5, which represents a worse-case scenario (Fig. 6). Rice landraces appear relatively well-adapted under the past maximum temperature scenario, except for some varieties in the northern range of rice cultivation which is consistent with past findings that temperate-adapted northern varieties possibly started growing in these regions after a global temperature decline 4,200 years ago [@gutaker2020] (Fig. 6).

To make predictions about where the climate is likely to be optimal for rice-growing in the future, we sampled 10,000 grids from across Asia and calculated genomic offset scores for each individual in the environment of each grid, for the three SSP scenarios. We interpret the grid with the lowest offset score as a possible future optimal location for each rice individual. As a measure of the extent of movement that would be required for adaptation, we subtract the absolute value of the current latitude of each rice individual from the absolute value of the centroid latitude of the optimal grid; positive values of this absolute latitudinal distance indicate movement away from the equator.

# Code Availability

All analyses carried out in `R` [@base]. The entire analysis is run via reproducible `.qmd` notebooks available [here](https://github.com/nick-gauthier/rice).

# Data Availability

All data required to reproduce the analysis is included with the analysis code or available from public sources linked therein.

# Author Contributions

**Nicolas Gauthier:** conceptualization, methodology, software, formal analysis, investigation, data curation, writing - original draft, writing – review and editing, visualization. **Ornob Alam:** methodology, software, data curation, formal analysis, writing - review and editing. **Michael Purugganan:** methodology, writing – review and editing, supervision, funding acquisition. **Jade d'Alpoim Guedes:** conceptualization, methodology, validation, data curation, writing – original draft, writing – review and editing, supervision, funding acquisition.

# Acknowledgements

This work was supported by a grant from the Ziegler Family Foundation.

# Supplementary Material

```{r}
#| label: tbl-quantiles
#| tbl-cap: "Present-day rice extent quantiles across three datasets of varying resolution and spatiotemporal support."

quants_mod_monfreda <- monfreda_occ %>%
  st_drop_geometry() %>%
  filter(presence == 1) %>%
  select(bio1, bio5, bio10) %>%
  mutate(across(everything(), ~units::set_units(.x, 'degree_C'))) %>%
  reframe(across(everything(), 
                   ~quantile(.x, quantiles, type = 8))) %>%
  round(1) %>%
  mutate(quantile = quantiles, .before = 1)

quants_mod_gbif <- occ_dat %>%
  st_drop_geometry() %>%
  filter(presence == 1) %>%
  select(bio1, bio5, bio10) %>%
  mutate(across(everything(), ~units::set_units(.x, 'degree_C'))) %>%
  reframe(across(everything(), 
                   ~quantile(.x, quantiles, type = 8))) %>%
  round(1) %>%
  mutate(quantile = quantiles, .before = 1)

left_join(quants_mod, quants_mod_monfreda, by = 'quantile') %>%
  left_join(quants_mod_gbif, by = 'quantile') %>%
  units::drop_units() %>% # do we want celsius units?
  mutate(quantile = set_units(quantile * 100, '%')) %>% 
  select(quantile, bio1.x, bio1.y, bio1, bio5.x, bio5.y, bio5, bio10.x, bio10.y, bio10) %>%
  setNames(c('Quantile', rep(c('IRRI', 'Monfreda', 'GBIF'), 3))) %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling('striped') %>%
  kableExtra::add_header_above(tibble(names = c('', 'Mean Annual Temperature', 'Max Temp. of the Warmest Month', 'Max Temp. of the Warmest Quarter'), spans = c(1,3,3,3)))  #%>%
  #kableExtra::save_kable('data/data-derived/quantiles_table.png')
```

![Present-day rice extent quantiles across three datasets of varying resolution and spatiotemporal support.](data/data-derived/quantiles_table.png){#tbl-quantiles-2 width="6in"}

![Rice distribution data: a) IRRI, b) Monfreda et al., c) GBIF. Occurrence points in red, background points in black.](figures/data_fig.png){#fig-occurrences width="6in"}

```{r}
#| label: fig-country-summaries
#| fig-width: 6.5
#| fig-height: 6
#| fig-cap: "Projected increases in land area surpassing key temperature thresholds in each of the top 15 rice-producing countries in east Asia."
country_stats %>% 
  ggplot(aes(ssp, percent, group = variable, color = variable)) +
  facet_wrap(~name) +
  scale_color_manual(values = c('#abdda4', '#fdae61', '#d7191c'
)) +
  geom_line(linewidth = 1.2) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

<!--# call this out in main txt! -->

```{r}
#| label: tbl-country-summaries-table
#| tbl-cap: "Projected increases in land area surpassing key temperature thresholds in each of the top 15 rice-producing countries in east Asia."

country_stats %>%
  mutate(percent = round(percent)) %>%
  filter(variable == 'Mean annual temperature') %>%
  select(-sum, -area) %>%
  pivot_wider(names_from = ssp, 
              values_from = percent) %>%
  select(Country = name, Present = present, `SSP1-2.6`:`SSP5-8.5`) %>%
  knitr::kable()
  #gt::gt() %>%
  #gt::tab_header(title = "Percent land area surpassing MAT threshold")

country_stats %>%
  mutate(percent = round(percent)) %>%
  filter(variable == 'Max temperature of warmest quarter') %>%
    select(-sum, -area) %>%
  pivot_wider(names_from = ssp, 
              values_from = percent) %>%
  select(Country = name, Present = present, `SSP1-2.6`:`SSP5-8.5`) %>%
  gt::gt() %>%
  gt::tab_header(title = "Percent land area surpassing T-WARM threshold")

country_stats %>%
  mutate(percent = round(percent)) %>%
  filter(variable == 'Max temperature of warmest month') %>%
    select(-sum, -area) %>%
  pivot_wider(names_from = ssp, 
              values_from = percent) %>%
  select(Country = name, Present = present, `SSP1-2.6`:`SSP5-8.5`) %>%
  gt::gt() %>%
  gt::tab_header(title = "Percent land area surpassing T-HOT threshold")
```

```{r}
#| label: fig-niche-all-models-bio10
#| cache: true
#| fig-width: 8
#| fig-height: 12
#| fig-cap: Predicted changes in mean maximum temperature of the warmest quarter over currently cultivated rice areas in Asia for multiple CMIP6 ensemble members.

ggplot() +
  geom_stars(data = slice(cmip6, 'variable', 2) > units::drop_units(bio10_limit), downsample = 20) +
  facet_grid(model~ssp) +
  scale_fill_manual(values = c('grey', 'red'), 
                       name = paste0('twarm > ', bio10_limit),
                    na.value = NA, na.translate = FALSE) +
  geom_sf(data = coasts) +
  labs(x = '', y = '')
```

```{r}
#| label: fig-niche-all-models-bio5
#| cache: true
#| fig-width: 8
#| fig-height: 12
#| fig-cap: Predicted changes in mean maximum temperature of the warmest month over currently cultivated rice areas in Asia for multiple CMIP6 ensemble members.

ggplot() +
  geom_stars(data = slice(cmip6, 'variable', 3) > units::drop_units(bio5_limit), downsample = 20) +
  facet_grid(model~ssp) +
  scale_fill_manual(values = c('grey', 'red'), 
                    name = paste0('tmax > ', bio5_limit), 
                    na.value = NA, na.translate = FALSE) +
  geom_sf(data = coasts) +
  labs(x = '', y = '')
```

```{r}
#| label: fig-niche-all-models-bio1
#| cache: true
#| fig-width: 8
#| fig-height: 12
#| fig-cap: Predicted changes in mean annual temperature over currently cultivated rice areas in Asia for multiple CMIP6 ensemble members.

ggplot() +
  geom_stars(data = slice(cmip6, 'variable', 1) > units::drop_units(bio1_limit), downsample = 20) +
  facet_grid(model~ssp) +
  scale_fill_manual(values = c('grey', 'red'), 
                    name = paste0('MAT > ', bio1_limit), 
                    na.value = NA, na.translate = FALSE) +
  geom_sf(data = coasts) +
  labs(x = '', y = '')
```

```{r}
#| label: ens
#| fig-width: 6
#| fig-height: 4
#| eval: false
#| cache: true

ens_mean <- st_apply(cmip6, 1:4, mean)

ggplot() +
  geom_stars(data = slice(ens_mean, 'variable', 2) > units::drop_units(bio10_limit), downsample = 20) +
  facet_wrap(~ssp) +
  scale_fill_manual(values = c('grey', 'red'), 
                    name = paste0('twarm > ', bio10_limit), 
                    na.value = NA, na.translate = FALSE) +
  geom_sf(data = coasts) +
  labs(x = '', y = '')

ggplot() +
  geom_stars(data = slice(ens_mean, 'variable', 1) > units::drop_units(bio1_limit), downsample = 20) +
  facet_wrap(~ssp) +
  scale_fill_manual(values = c('grey', 'red'), 
                    name = paste0('MAT > ', bio1_limit), 
                    na.value = NA, na.translate = FALSE) +
  geom_sf(data = coasts) +
  labs(x = '', y = '')

ggplot() +
  geom_stars(data = slice(ens_mean, 'variable', 3) > units::drop_units(bio5_limit), downsample = 20) +
  facet_wrap(~ssp) +
  scale_fill_manual(values = c('grey', 'red'), 
                    name = paste0('tmax > ', bio5_limit), 
                    na.value = NA, na.translate = FALSE) +
  geom_sf(data = coasts) +
  labs(x = '', y = '')
```

```{r}
#| label: fig-erb-recon
#| fig-width: 9
#| fig-height: 8
#| fig-cap: "EOF analysis of Holocene temperature reconstruction reveals two leading modes of decadal-scale variability that collectively explain 86% of the decadal scale temperature variability. We focus on the period from 7000 to 1000 years ago to remove impacts from the last deglaciation and contemporary greenhouse gas emissions. These two modes reflect North and South China variability. The northern part of China has become cooler while the South has become warmer over time. A trailing third mode represents a dipole pattern in Australia and Indonesia focused on the period around 6000 BP, reflecting the opening of the Sunda shelf and its concomitant impact on the monsoon system."
  
library(tidyEOF)
pat <- get_patterns(erb_decadal %>% filter(between(time, -7000, -1000)), 
                    k = 3, scale = TRUE, rotate = FALSE)
eof <- plot_eofs(pat) +
  geom_sf(data = coasts) +
  geom_sf(data = arch_trace_dat %>%
  filter(med_age < -2000), size = 0.5)

amp <- plot_amps(pat, scaled = FALSE) + 
  geom_smooth()

eof / amp + plot_layout(heights = c(2,1))
```

```{r}
#| label: fig-bootstrap
#| fig-width: 6
#| fig-height: 9
#| fig-cap: "Bootstrapped kernel density estimates of rice's thermal extent throughout the Holocene. Bootstrap resampling accounts for uncertainty in radiocarbon and phase-based dating of archaeological rice finds. Contemporary temperature tresholds indicated in red."

trace_boot <- readRDS('data/data-derived/trace_boot.rds')

boot_1 <-  trace_boot %>%
  filter(time <= -2000) %>%
  select(rep, MAT:twarm) %>%
  pivot_longer(MAT:twarm) %>%
  group_by(rep, name) %>%
  tidy_kde() %>%
ggplot(aes(value, estimate)) +
  geom_line(alpha = 0.01, aes(group = rep)) +
  facet_wrap(~name, scales = 'free_y', nrow = 3) +
  geom_vline(data = quant_975 |>
  select(-quantile) |>
  setNames(c('MAT', 'tmax', 'twarm')) |>
  pivot_longer(everything()),
  aes(xintercept = as.numeric(value)),
  linetype = 2, color = 'red')

boot_2 <- trace_boot %>%
    filter(time <= -2000) %>%
  pivot_longer(MAT:twarm, values_to = 'temperature') %>%
  mutate(temperature = units::set_units(temperature, 'degree_c')) %>%
  group_by(type, rep, name) %>%
  reframe(quant = quantile(temperature, 0.975, type = 8)) %>%
  ggplot(aes(quant)) +
  geom_histogram(position = 'stack', aes(fill = type)) +
  facet_wrap(~name, scales = 'free_x') +
  theme_bw()

rm(trace_boot)

boot_1 / boot_2 +  plot_annotation(tag_levels = 'A') + plot_layout(heights = c(2,1))
```

# References
